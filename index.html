<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–®–µ–≤—á–µ–Ω–∫–æ 360¬∞ | –°–≤—ñ—Ç–æ–≤–∏–π —Ä–µ—î—Å—Ç—Ä</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        :root { --blue: #0057b7; --gold: #ffd700; --dark: #1a1a1a; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #f4f7f6; overflow: hidden; }
        
        /* –°–¢–†–£–ö–¢–£–†–ê –ü–ê–ù–ï–õ–ï–ô */
        #main-container { display: flex; height: 100vh; transition: 0.5s; }
        #sidebar { width: 340px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; z-index: 1000; }
        #map { flex: 1; z-index: 1; }

        /* –°–¢–û–†–Ü–ù–ö–ê –û–ë'–Ñ–ö–¢–ê (–ü–†–ò–•–û–í–ê–ù–ê –ó–ê –ó–ê–ú–û–í–ß–£–í–ê–ù–ù–Ø–ú) */
        #object-page { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: white; z-index: 2000; display: none; overflow-y: auto; 
        }
        .page-content { max-width: 1000px; margin: 0 auto; padding: 40px 20px; }
        .back-btn { background: var(--blue); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-bottom: 20px; }
        
        .grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; }
        @media (max-width: 768px) { .grid-layout { grid-template-columns: 1fr; } }

        /* –ì–ê–õ–ï–†–ï–Ø */
        .gallery img { width: 100%; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 10px; }
        .historical-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        /* –ü–ê–°–ü–û–†–¢ */
        .passport-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .passport-table td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
        .passport-table td:first-child { font-weight: bold; color: #777; width: 30%; }

        /* –ö–ù–û–ü–ö–ê –ú–ê–†–®–†–£–¢–£ */
        .route-btn { 
            display: inline-block; background: #28a745; color: white; text-decoration: none; 
            padding: 15px 30px; border-radius: 8px; font-weight: bold; text-align: center; width: 100%; box-sizing: border-box;
        }

        /* –Ü–ù–®–ï */
        .header { padding: 25px 20px; background: var(--blue); color: white; }
        .filters { padding: 20px; overflow-y: auto; flex: 1; }
        .filter-group { margin-bottom: 15px; }
        label { font-size: 11px; font-weight: bold; color: #999; text-transform: uppercase; }
        select, input { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="main-container">
        <div id="sidebar">
            <div class="header">
                <h2 style="margin:0">–®–µ–≤—á–µ–Ω–∫–æ 360¬∞</h2>
                <p style="margin:5px 0 0; font-size:12px; opacity:0.8">–°–≤—ñ—Ç–æ–≤–∏–π —Ä–µ—î—Å—Ç—Ä</p>
            </div>
            <div class="filters">
                <div class="filter-group"><label>–ü–æ—à—É–∫</label><input type="text" id="searchInput" placeholder="–ú—ñ—Å—Ç–æ, —Ä—ñ–∫, –∞–≤—Ç–æ—Ä..."></div>
                <div class="filter-group"><label>–ö—Ä–∞—ó–Ω–∞</label><select id="countryFilter"><option value="all">–£—Å—ñ –∫—Ä–∞—ó–Ω–∏</option></select></div>
                <div class="filter-group"><label>–¢–∏–ø</label><select id="typeFilter"><option value="all">–£—Å—ñ —Ç–∏–ø–∏</option></select></div>
            </div>
            <div id="counter" style="padding:15px; text-align:center; font-weight:bold; color:var(--blue)">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
        </div>
        <div id="map"></div>
    </div>

    <div id="object-page">
        <div class="page-content">
            <button class="back-btn" onclick="closeObjectPage()">‚Üê –ù–∞–∑–∞–¥ –¥–æ –∫–∞—Ä—Ç–∏</button>
            <div id="object-details"></div>
        </div>
    </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
    const map = L.map('map').setView([48.5, 31.2], 4);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
    const markers = L.markerClusterGroup();
    map.addLayer(markers);

    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTxfvvWkJdsGNJBOWM3oftjwmKf4xe6q4xOqrztdTmLSYskX49VhYzU6CCzPNRFWHojuW59X4sxlbrY/pub?output=csv';
    let dataItems = [];

    // –§—É–Ω–∫—Ü—ñ—è –±–µ–∑–ø–µ—á–Ω–æ–≥–æ —á–∏—Ç–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö
    function getV(obj, key) {
        const found = Object.keys(obj).find(k => k.trim() === key.trim());
        return found ? obj[found] : "";
    }

    // –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –î–ê–ù–ò–•
    Papa.parse(csvUrl, {
        download: true, header: true, skipEmptyLines: true,
        complete: function(results) {
            dataItems = results.data;
            populateFilters();
            updateMap();
            checkUrlParams(); // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ –º–∏ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –æ–±'—î–∫—Ç–∞
        }
    });

    function populateFilters() {
        const countries = [...new Set(dataItems.map(i => getV(i, 'Country')))].filter(Boolean).sort();
        const types = [...new Set(dataItems.map(i => getV(i, 'type')))].filter(Boolean).sort();
        
        const cFilter = document.getElementById('countryFilter');
        countries.forEach(c => cFilter.innerHTML += `<option value="${c}">${c}</option>`);
        
        const tFilter = document.getElementById('typeFilter');
        types.forEach(t => tFilter.innerHTML += `<option value="${t}">${t}</option>`);
    }

    function updateMap() {
        markers.clearLayers();
        const search = document.getElementById('searchInput').value.toLowerCase();
        
        dataItems.forEach(item => {
            const lat = parseFloat(getV(item, 'lat').replace(',', '.'));
            const lon = parseFloat(getV(item, 'lon').replace(',', '.'));
            if (isNaN(lat)) return;

            const city = getV(item, 'City');
            const id = getV(item, 'id');

            // –Ø–∫—â–æ —î –ø–æ—à—É–∫, —Ñ—ñ–ª—å—Ç—Ä—É—î–º–æ
            if (search && !(`${city} ${getV(item, 'sculptor')}`).toLowerCase().includes(search)) return;

            const m = L.marker([lat, lon]);
            m.bindPopup(`
                <b>${city}</b><br>${getV(item, 'Country')}<br><br>
                <button onclick="openObjectPage('${id}')" style="width:100%; cursor:pointer">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –∫–∞—Ä—Ç–∫—É</button>
            `);
            markers.addLayer(m);
        });
        document.getElementById('counter').innerText = `–ó–Ω–∞–π–¥–µ–Ω–æ: ${dataItems.length}`;
    }

    // –†–û–ë–û–¢–ê –ó–Ü –°–¢–û–†–Ü–ù–ö–û–Æ –û–ë'–Ñ–ö–¢–ê
    function openObjectPage(id) {
        const item = dataItems.find(i => getV(i, 'id') === id);
        if (!item) return;

        // –û–Ω–æ–≤–ª—é—î–º–æ URL –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        window.history.pushState({}, '', `?id=${id}`);
        
        const lat = getV(item, 'lat').replace(',', '.');
        const lon = getV(item, 'lon').replace(',', '.');
        const mainImg = getV(item, 'Photo-GM') || getV(item, 'other photo link');
        const histImg = getV(item, 'other photo link');

        const html = `
            <h1>${getV(item, 'City')} ‚Äî ${getV(item, 'Country')}</h1>
            <div class="grid-layout">
                <div class="gallery">
                    <img src="${mainImg}" alt="–ì–æ–ª–æ–≤–Ω–µ —Ñ–æ—Ç–æ" onerror="this.style.display='none'">
                    <div class="historical-grid">
                        ${histImg ? `<img src="${histImg}" alt="–Ü—Å—Ç–æ—Ä–∏—á–Ω–µ —Ñ–æ—Ç–æ">` : ''}
                    </div>
                </div>
                <div class="info">
                    <div style="background:#ffd700; padding:10px; border-radius:5px; font-weight:bold; margin-bottom:20px">
                        –¢–ò–ü: ${getV(item, 'type')}
                    </div>
                    
                    <h3>–ü–∞—Å–ø–æ—Ä—Ç –æ–±'—î–∫—Ç–∞</h3>
                    <table class="passport-table">
                        <tr><td>–ú–∞—Ç–µ—Ä—ñ–∞–ª</td><td>${getV(item, 'material') || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</td></tr>
                        <tr><td>–°–∫—É–ª—å–ø—Ç–æ—Ä</td><td>${getV(item, 'sculptor') || '–Ω/–¥'}</td></tr>
                        <tr><td>–ê—Ä—Ö—ñ—Ç–µ–∫—Ç–æ—Ä</td><td>${getV(item, 'arkhitector') || '–Ω/–¥'}</td></tr>
                        <tr><td>–†—ñ–∫ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è</td><td>${getV(item, 'year_start') || '–Ω/–¥'}</td></tr>
                        <tr><td>–†–µ–≥—ñ–æ–Ω</td><td>${getV(item, 'Region') || '-'}</td></tr>
                    </table>

                    <h3>–û–ø–∏—Å</h3>
                    <div style="line-height:1.6; color:#444; margin-bottom:30px">
                        ${getV(item, 'short description') || '–û–ø–∏—Å –æ—á—ñ–∫—É—î—Ç—å—Å—è...'}
                    </div>

                    <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}" 
                       target="_blank" class="route-btn">
                       üöÄ –ü–æ–±—É–¥—É–≤–∞—Ç–∏ –º–∞—Ä—à—Ä—É—Ç
                    </a>
                </div>
            </div>
        `;

        document.getElementById('object-details').innerHTML = html;
        document.getElementById('object-page').style.display = 'block';
    }

    function closeObjectPage() {
        window.history.pushState({}, '', window.location.pathname);
        document.getElementById('object-page').style.display = 'none';
    }

    function checkUrlParams() {
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        if (id) openObjectPage(id);
    }

    // –°–ª—É—Ö–∞—á—ñ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
    document.getElementById('searchInput').addEventListener('input', updateMap);
    document.getElementById('countryFilter').addEventListener('change', updateMap);
</script>
</body>
</html>
