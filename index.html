<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Шевченко: Світовий каталог</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: 'Segoe UI', Arial, sans-serif; background: #f4f7f6; }
        #sidebar { width: 320px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 1000; }
        .header { padding: 20px; background: #0057b7; color: white; }
        .filters { padding: 20px; overflow-y: auto; flex: 1; }
        .filter-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        select, input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 14px; }
        #map { flex: 1; }
        #counter { padding: 15px; background: #eee; text-align: center; font-weight: bold; font-size: 14px; color: #0057b7; }
        
        /* Стиль для прихованого фільтра областей */
        #regionFilterGroup { 
            display: none; 
            background: #f0f7ff; 
            padding: 10px; 
            border-radius: 5px; 
            border: 1px dashed #0057b7;
            margin-top: -10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="header">
        <h2 style="margin:0">Кобзар по світу</h2>
        <p style="margin:5px 0 0; opacity:0.8; font-size:12px">Інтерактивна мапа пам'ятників</p>
    </div>
    
    <div class="filters">
        <div class="filter-group">
            <label>Пошук</label>
            <input type="text" id="searchInput" placeholder="Місто, автор, рік...">
        </div>

        <div class="filter-group">
            <label>Країна</label>
            <select id="countryFilter"><option value="all">Усі країни</option></select>
        </div>

        <div id="regionFilterGroup" class="filter-group">
            <label>Область України</label>
            <select id="regionFilter"><option value="all">Усі області</option></select>
        </div>

        <div class="filter-group">
            <label>Тип об'єкта</label>
            <select id="typeFilter"><option value="all">Усі типи</option></select>
        </div>

        <div class="filter-group">
            <label>Вигляд Кобзаря</label>
            <select id="viewFilter"><option value="all">Усі варіанти</option></select>
        </div>
    </div>
    <div id="counter">Завантаження...</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
    const map = L.map('map').setView([48.5, 31.2], 4);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
    const markers = L.markerClusterGroup();
    map.addLayer(markers);

    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTxfvvWkJdsGNJBOWM3oftjwmKf4xe6q4xOqrztdTmLSYskX49VhYzU6CCzPNRFWHojuW59X4sxlbrY/pub?output=csv';

    let dataItems = [];

    Papa.parse(csvUrl, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
            dataItems = results.data;
            populateFilters();
            updateMap();
        }
    });

    function populateFilters() {
        const countries = [...new Set(dataItems.map(i => i.Country))].filter(Boolean).sort();
        const regions = [...new Set(dataItems.map(i => i.Region))].filter(Boolean).sort();
        const types = [...new Set(dataItems.map(i => i.type))].filter(Boolean).sort();
        const views = [...new Set(dataItems.map(i => i.view))].filter(Boolean).sort();

        fillSelect('countryFilter', countries);
        fillSelect('regionFilter', regions);
        fillSelect('typeFilter', types);
        fillSelect('viewFilter', views);
    }

    function fillSelect(id, list) {
        const sel = document.getElementById(id);
        list.forEach(item => {
            const opt = document.createElement('option');
            opt.value = opt.innerText = item;
            sel.appendChild(opt);
        });
    }

    // ЛОГІКА ПОКАЗУ ОБЛАСТЕЙ
    document.getElementById('countryFilter').addEventListener('change', function() {
        const regionGroup = document.getElementById('regionFilterGroup');
        if (this.value === 'Україна' || this.value === 'Ukraine') {
            regionGroup.style.display = 'block';
        } else {
            regionGroup.style.display = 'none';
            document.getElementById('regionFilter').value = 'all'; // Скидаємо фільтр області
        }
        updateMap();
    });

    function updateMap() {
        markers.clearLayers();
        const s = document.getElementById('searchInput').value.toLowerCase();
        const fCountry = document.getElementById('countryFilter').value;
        const fRegion = document.getElementById('regionFilter').value;
        const fType = document.getElementById('typeFilter').value;
        const fView = document.getElementById('viewFilter').value;

        let count = 0;

        dataItems.forEach(item => {
            const lat = parseFloat(item.lat ? item.lat.replace(',', '.') : 0);
            const lon = parseFloat(item.lon ? item.lon.replace(',', '.') : 0);
            if (!lat || !lon) return;

            // Фільтрація
            if (fCountry !== 'all' && item.Country !== fCountry) return;
            // Фільтр по області (працює лише якщо країна - Україна)
            if (fCountry === 'Україна' && fRegion !== 'all' && item.Region !== fRegion) return;
            
            if (fType !== 'all' && item.type !== fType) return;
            if (fView !== 'all' && item.view !== fView) return;
            
            const searchPool = `${item.title} ${item.City} ${item.sculptor} ${item.Region}`.toLowerCase();
            if (s && !searchPool.includes(s)) return;

            const marker = L.marker([lat, lon]);
            marker.bindPopup(`
                <div style="width:220px; font-size:13px">
                    <b style="font-size:15px; color:#0057b7">${item.City || 'Без назви'}</b><br>
                    <small>${item.Region ? item.Region + ' обл., ' : ''}${item.Country}</small>
                    <hr style="border:0; border-top:1px solid #eee">
                    <b>Рік:</b> ${item.year_start || 'н/д'}<br>
                    <b>Тип:</b> ${item.type || 'н/д'}<br>
                    <b>Автор:</b> ${item.sculptor || 'н/д'}<br>
                    <p style="margin-top:8px; font-style:italic">${item['short description'] || ''}</p>
                    ${item['Photo-GM-link'] ? `<a href="${item['Photo-GM-link']}" target="_blank" style="color:#0057b7">Переглянути фото</a>` : ''}
                </div>
            `);
            markers.addLayer(marker);
            count++;
        });

        document.getElementById('counter').innerText = `Знайдено: ${count}`;
    }

    // Слухачі для всіх інших фільтрів
    document.getElementById('searchInput').addEventListener('input', updateMap);
    document.getElementById('regionFilter').addEventListener('change', updateMap);
    document.getElementById('typeFilter').addEventListener('change', updateMap);
    document.getElementById('viewFilter').addEventListener('change', updateMap);
</script>

</body>
</html>
