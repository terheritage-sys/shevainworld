<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–®–µ–≤—á–µ–Ω–∫–æ 360¬∞ | –°–≤—ñ—Ç–æ–≤–∏–π —Ä–µ—î—Å—Ç—Ä</title>
<meta property="og:type" content="website">
<meta property="og:title" content="–®–µ–≤—á–µ–Ω–∫–æ 360¬∞ | –°–≤—ñ—Ç–æ–≤–∞ –∫–∞—Ä—Ç–∞ –æ–±'—î–∫—Ç—ñ–≤">
<meta property="og:description" content="–Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏–π —Ä–µ—î—Å—Ç—Ä –ø–∞–º'—è—Ç–Ω–∏–∫—ñ–≤ –ö–æ–±–∑–∞—Ä—é –ø–æ –≤—Å—å–æ–º—É —Å–≤—ñ—Ç—É.">
<meta property="og:url" content="https://terheritage-sys.github.io/">
<meta property="og:image" content="https://terheritage-sys.github.io/logo_preview.jpg">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"/>
<style>
:root{--blue:#0057b7;--gold:#ffd700;--gold-dark:#c8900a;--bg:#f2f4f8;--text:#2a2d35;--muted:#7a8090;--sidebar-w:410px;--radius:10px;--shadow:0 4px 20px rgba(0,0,0,0.12);}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Nunito',sans-serif;display:flex;height:100vh;overflow:hidden;background:var(--bg);color:var(--text);}
#sidebar{width:var(--sidebar-w);background:#fff;border-right:1px solid #e8eaf0;display:flex;flex-direction:column;z-index:2000;box-shadow:2px 0 20px rgba(0,0,0,0.08);transition:transform 0.3s ease;}
.sidebar-header{padding:16px 20px 0;background:var(--blue);color:white;flex-shrink:0;}
.sidebar-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;}
.sidebar-title{font-family:'Playfair Display',serif;font-size:28px;font-weight:900;}
.sidebar-title span{color:var(--gold);}
.btn-reset{background:rgba(255,255,255,0.18);color:white;border:1px solid rgba(255,255,255,0.4);padding:6px 14px;border-radius:20px;font-size:15px;cursor:pointer;font-weight:700;font-family:'Nunito',sans-serif;transition:background 0.2s;}
.btn-reset:hover{background:rgba(255,255,255,0.3);}
.close-btn{display:none;background:none;border:none;color:white;font-size:32px;cursor:pointer;line-height:1;padding:0 6px;}
.tabs{display:flex;margin:0 -20px;}
.tab-btn{flex:1;padding:11px 4px;background:rgba(0,0,0,0.15);color:rgba(255,255,255,0.75);border:none;cursor:pointer;font-size:15px;font-weight:700;font-family:'Nunito',sans-serif;transition:all 0.2s;border-top:2px solid transparent;}
.tab-btn.active{background:#fff;color:var(--blue);border-top:2px solid var(--gold);}
.tab-panel{display:none;flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;}
.tab-panel.active{display:flex;flex-direction:column;}
#tab-filters{padding:13px 15px;gap:11px;}
.filter-section{background:#f8f9fc;border-radius:var(--radius);padding:13px 15px;border:1px solid #ebeef5;}
.filter-label{font-size:14px;color:var(--muted);text-transform:uppercase;font-weight:800;letter-spacing:0.8px;margin-bottom:10px;display:flex;align-items:center;gap:6px;}
input[type="text"]{width:100%;padding:10px 13px;border:1.5px solid #e0e3eb;border-radius:8px;font-size:18px;font-family:'Nunito',sans-serif;outline:none;background:#fff;transition:border-color 0.2s;}
input[type="text"]:focus{border-color:var(--blue);}
.tag-container{display:flex;flex-wrap:wrap;gap:6px;}
.stat-tag{display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:20px;font-size:15px;cursor:pointer;transition:all 0.15s;border:1.5px solid #e0e3eb;background:#fff;font-weight:700;user-select:none;}
.stat-tag:hover{border-color:var(--blue);color:var(--blue);}
.stat-tag.active{background:var(--blue);color:white;border-color:var(--blue);}
.stat-tag .dot{width:9px;height:9px;border-radius:50%;flex-shrink:0;}
.stat-tag .cnt{opacity:0.65;font-size:13px;}
.stat-tag.active .cnt{opacity:1;color:var(--gold);}
.tag-scroll{max-height:170px;overflow-y:auto;border:1.5px solid #e0e3eb;border-radius:8px;background:#fff;padding:4px;}
.tag-scroll-item{display:flex;align-items:center;justify-content:space-between;padding:8px 11px;border-radius:6px;cursor:pointer;font-size:15px;font-weight:700;transition:all 0.12s;border-bottom:1px solid #f0f2f8;}
.tag-scroll-item:last-child{border-bottom:none;}
.tag-scroll-item:hover{background:#f0f7ff;color:var(--blue);}
.tag-scroll-item.active{background:var(--blue);color:white;}
.tag-scroll-item .cnt-badge{font-size:13px;opacity:0.7;font-weight:700;}
.tag-scroll-item.active .cnt-badge{opacity:1;color:var(--gold);}
#regionPanel{margin-top:9px;display:none;background:#f0f7ff;border:1px dashed var(--blue);border-radius:8px;padding:9px;}
.range-wrap{position:relative;padding:8px 0 24px;}
.range-track-bg{position:absolute;top:16px;left:0;right:0;height:5px;background:#e0e3eb;border-radius:3px;}
.range-track-fill{position:absolute;top:16px;height:5px;background:var(--blue);border-radius:3px;}
.range-wrap input[type=range]{position:absolute;top:0;left:0;width:100%;margin:0;padding:0;-webkit-appearance:none;appearance:none;background:transparent;border:none;height:32px;pointer-events:none;outline:none;}
.range-wrap input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;pointer-events:all;width:20px;height:20px;background:var(--blue);border-radius:50%;border:2.5px solid white;box-shadow:0 2px 8px rgba(0,87,183,0.4);cursor:pointer;}
.range-wrap input[type=range]::-moz-range-thumb{pointer-events:all;width:20px;height:20px;background:var(--blue);border-radius:50%;border:2.5px solid white;cursor:pointer;}
.range-labels{display:flex;justify-content:space-between;position:absolute;bottom:0;left:0;right:0;}
.range-labels span{font-size:15px;font-weight:800;color:var(--blue);}
.autocomplete-wrap{position:relative;}
#sculptorClear{position:absolute;right:11px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--muted);font-size:22px;display:none;line-height:1;}
.seg-group{display:flex;flex-direction:column;gap:11px;}
.seg-label{font-size:14px;font-weight:700;color:var(--text);margin-bottom:5px;}
.seg-ctrl{display:flex;border:1.5px solid #e0e3eb;border-radius:8px;overflow:hidden;background:#fff;}
.seg-btn{flex:1;padding:9px 5px;background:transparent;border:none;cursor:pointer;font-size:14px;font-weight:700;font-family:'Nunito',sans-serif;color:var(--muted);transition:all 0.15s;text-align:center;border-right:1px solid #e0e3eb;line-height:1.3;}
.seg-btn:last-child{border-right:none;}
.seg-btn.active{background:var(--blue);color:white;}
.seg-btn:hover:not(.active){background:#f0f7ff;color:var(--blue);}
.toggle-row{display:flex;justify-content:space-between;align-items:center;}
.toggle-label{font-size:17px;font-weight:600;color:var(--text);display:flex;align-items:center;gap:7px;}
.toggle{position:relative;width:42px;height:23px;}
.toggle input{opacity:0;width:0;height:0;}
.slider-toggle{position:absolute;cursor:pointer;inset:0;background:#d0d5e8;border-radius:23px;transition:0.3s;}
.slider-toggle:before{position:absolute;content:"";width:17px;height:17px;left:3px;top:3px;background:white;border-radius:50%;transition:0.3s;}
.toggle input:checked+.slider-toggle{background:var(--blue);}
.toggle input:checked+.slider-toggle:before{transform:translateX(19px);}
#tab-list{padding:12px;gap:8px;}
.list-toolbar{display:flex;align-items:center;justify-content:space-between;padding:0 2px 5px;flex-shrink:0;}
.list-count{font-size:15px;color:var(--muted);font-weight:700;}
.list-grid{display:flex;flex-direction:column;gap:8px;padding-bottom:10px;}
.list-card{display:flex;gap:11px;background:#fff;border-radius:var(--radius);border:1px solid #ebeef5;padding:11px;cursor:pointer;transition:all 0.15s;align-items:center;}
.list-card:hover{border-color:var(--blue);box-shadow:0 3px 14px rgba(0,87,183,0.1);transform:translateY(-1px);}
.list-card-img{width:58px;height:58px;border-radius:8px;object-fit:cover;flex-shrink:0;background:#ebeef5;}
.list-card-body{flex:1;min-width:0;}
.list-card-city{font-size:18px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.list-card-sub{font-size:15px;color:var(--muted);margin-top:2px;}
.list-card-type{display:inline-block;font-size:13px;font-weight:800;text-transform:uppercase;padding:2px 8px;border-radius:10px;color:white;margin-top:4px;}
.list-empty{text-align:center;color:var(--muted);font-size:18px;padding:32px 20px;line-height:1.5;}
#tab-stats{padding:14px 16px;gap:14px;}
.stat-card{background:#f8f9fc;border:1px solid #ebeef5;border-radius:var(--radius);padding:14px;}
.stat-card-title{font-size:14px;text-transform:uppercase;font-weight:800;color:var(--muted);letter-spacing:0.8px;margin-bottom:13px;}
.stat-numbers{display:grid;grid-template-columns:1fr 1fr;gap:9px;}
.stat-num-box{background:white;border-radius:9px;padding:12px;text-align:center;border:1px solid #ebeef5;transition:all 0.15s;}
.stat-num-box.clickable{cursor:pointer;}
.stat-num-box.clickable:hover{border-color:var(--blue);box-shadow:0 3px 12px rgba(0,87,183,0.12);transform:translateY(-1px);}
.stat-num-val{font-family:'Playfair Display',serif;font-size:34px;font-weight:900;color:var(--blue);}
.stat-num-label{font-size:14px;color:var(--muted);font-weight:700;margin-top:3px;}
.bar-chart{display:flex;flex-direction:column;gap:7px;}
.bar-row{display:flex;align-items:center;gap:8px;font-size:15px;cursor:pointer;border-radius:6px;padding:3px 5px;margin:-3px -5px;transition:background 0.15s;}
.bar-row:hover{background:#eef2fb;}
.bar-row:hover .bar-name{color:var(--blue);}
.bar-name{width:120px;flex-shrink:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:600;}
.bar-track{flex:1;background:#e8eaf0;border-radius:3px;height:9px;overflow:hidden;}
.bar-fill{height:100%;border-radius:3px;background:var(--blue);transition:width 0.5s;}
.bar-val{width:32px;text-align:right;color:var(--muted);font-weight:700;flex-shrink:0;}
.decade-chart{display:flex;align-items:flex-end;gap:3px;height:90px;padding-bottom:22px;position:relative;}
.decade-col{flex:1;display:flex;flex-direction:column;align-items:center;position:relative;cursor:pointer;}
.decade-col:hover .decade-bar{opacity:0.7;transform:scaleY(1.06);transform-origin:bottom;}
.decade-col:hover .decade-lbl{color:var(--blue);font-weight:800;}
.decade-bar{width:100%;background:var(--blue);border-radius:3px 3px 0 0;transition:height 0.5s,opacity 0.15s,transform 0.15s;min-height:2px;}
.decade-bar.gold{background:var(--gold-dark);}
.decade-lbl{position:absolute;bottom:-18px;font-size:11px;color:var(--muted);font-weight:700;white-space:nowrap;}
.donut-legend{display:flex;flex-wrap:wrap;gap:7px;margin-top:8px;}
.legend-item{display:flex;align-items:center;gap:5px;font-size:14px;font-weight:700;cursor:pointer;border-radius:6px;padding:4px 8px;margin:-4px -8px;transition:background 0.15s;}
.legend-item:hover{background:#eef2fb;}
.legend-item:hover span:first-of-type{color:var(--blue)!important;}
.legend-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.completeness-bars{display:flex;flex-direction:column;gap:8px;}
.comp-row{display:flex;align-items:center;gap:9px;font-size:15px;}
.comp-name{width:100px;flex-shrink:0;font-weight:600;}
.comp-track{flex:1;background:#e8eaf0;border-radius:3px;height:9px;overflow:hidden;}
.comp-fill{height:100%;border-radius:3px;}
.comp-pct{width:36px;text-align:right;font-weight:800;font-size:14px;color:var(--muted);flex-shrink:0;}
#counter{padding:11px 16px;text-align:center;font-size:15px;font-weight:800;color:var(--muted);border-top:1px solid #ebeef5;letter-spacing:0.3px;flex-shrink:0;}
#counter span{color:var(--blue);font-size:20px;}
#map-container{flex:1;position:relative;height:100%;}
#map{width:100%;height:100%;}
.map-fab{position:absolute;z-index:900;display:flex;flex-direction:column;gap:9px;right:60px;bottom:30px;}
.map-btn{background:white;border:none;border-radius:50%;width:46px;height:46px;box-shadow:var(--shadow);cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;transition:all 0.2s;position:relative;}
.map-btn:hover{transform:scale(1.08);box-shadow:0 6px 25px rgba(0,0,0,0.18);}
.map-btn-tooltip{position:absolute;right:54px;background:#2a2d35;color:white;padding:5px 11px;border-radius:7px;font-size:15px;font-weight:700;white-space:nowrap;pointer-events:none;opacity:0;transition:opacity 0.2s;}
.map-btn:hover .map-btn-tooltip{opacity:1;}
.mobile-menu-btn{display:none;position:absolute;top:16px;left:16px;z-index:1000;background:var(--blue);color:white;border:none;padding:12px 18px;border-radius:50px;font-weight:800;box-shadow:var(--shadow);cursor:pointer;align-items:center;gap:8px;font-size:18px;font-family:'Nunito',sans-serif;}
#map-legend{position:absolute;bottom:30px;left:20px;z-index:900;background:white;border-radius:var(--radius);padding:11px 14px;box-shadow:var(--shadow);font-size:14px;font-weight:700;display:flex;flex-direction:column;gap:6px;max-width:180px;}
.leg-item{display:flex;align-items:center;gap:8px;}
.leg-marker{width:15px;height:15px;border-radius:50%;flex-shrink:0;border:2px solid rgba(0,0,0,0.1);}
.leg-marker.square{border-radius:3px;}
.leg-marker.diamond{border-radius:0;transform:rotate(45deg);}
.leg-marker.demont{opacity:0.45;}
.leaflet-popup-content-wrapper{border-radius:14px !important;padding:0 !important;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.15) !important;}
.leaflet-popup-content{margin:0 !important;width:380px !important;}
.popup-card{display:flex;min-height:200px;}
.popup-photo-side{width:130px;background:#e8eaf0;flex-shrink:0;position:relative;overflow:hidden;}
.popup-photo{width:100%;height:100%;object-fit:cover;}
.popup-type-badge{position:absolute;top:9px;left:9px;font-size:11px;font-weight:800;text-transform:uppercase;padding:3px 8px;border-radius:10px;color:white;letter-spacing:0.4px;}
.popup-demont-badge{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.68);color:#fff;font-size:13px;font-weight:800;text-align:center;padding:5px;letter-spacing:0.3px;}
.popup-info{flex:1;padding:15px;display:flex;flex-direction:column;overflow:hidden;}
.popup-title{font-family:'Playfair Display',serif;font-size:21px;color:#1a1c22;font-weight:900;margin-bottom:6px;line-height:1.2;}
.popup-detail{font-size:15px;color:var(--muted);margin-bottom:3px;display:flex;align-items:center;gap:5px;}
.popup-desc{font-size:15px;color:#555;margin-top:8px;border-top:1px solid #f0f0f5;padding-top:8px;line-height:1.4;flex-grow:1;overflow:hidden;}
.more-btn{background:var(--blue);color:white;border:none;padding:9px;border-radius:8px;cursor:pointer;margin-top:10px;font-size:15px;font-weight:800;width:100%;font-family:'Nunito',sans-serif;transition:background 0.2s;}
.more-btn:hover{background:#0049a0;}
#object-page{position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:3000;display:none;overflow-y:auto;-webkit-overflow-scrolling:touch;}
.page-content{max-width:1060px;margin:0 auto;padding:36px 24px;}
.page-nav{display:flex;gap:10px;margin-bottom:26px;flex-wrap:wrap;}
.page-back,.page-rand{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;border:1.5px solid #e0e3eb;background:white;border-radius:9px;cursor:pointer;font-weight:700;font-size:18px;font-family:'Nunito',sans-serif;transition:all 0.2s;color:var(--text);text-decoration:none;}
.page-back:hover{border-color:var(--blue);color:var(--blue);}
.page-rand{background:var(--blue);color:white;border-color:var(--blue);}
.page-rand:hover{background:#0049a0;}
.grid-main{display:grid;grid-template-columns:1.1fr 1fr;gap:36px;}
.main-img-full{width:100%;border-radius:14px;box-shadow:0 12px 40px rgba(0,0,0,0.12);aspect-ratio:4/3;object-fit:cover;}
.passport-table{width:100%;border-collapse:collapse;margin-bottom:24px;}
.passport-table td{padding:10px 9px;border-bottom:1px solid #f0f2f8;font-size:20px;vertical-align:top;}
.passport-table td:first-child{font-weight:800;color:#9099b0;font-size:14px;text-transform:uppercase;letter-spacing:0.5px;width:38%;}
.section-title{font-size:15px;color:#b0b8cc;text-transform:uppercase;font-weight:800;margin:22px 0 11px;border-bottom:1px solid #f0f2f8;padding-bottom:6px;letter-spacing:0.8px;}
.comp-label{font-size:15px;color:var(--muted);font-weight:600;margin-bottom:7px;}
.completeness-bar{display:flex;gap:4px;margin-bottom:20px;}
.comp-seg{height:6px;flex:1;border-radius:3px;}
.comp-seg.filled{background:var(--blue);}
.comp-seg.empty{background:#e0e3eb;}
.links-grid{display:flex;flex-wrap:wrap;gap:8px;}
.ext-link-btn{text-decoration:none;padding:8px 13px;border-radius:8px;font-size:15px;background:#f4f6fb;color:var(--text);font-weight:700;border:1px solid #e0e3eb;display:flex;align-items:center;gap:6px;transition:all 0.15s;}
.ext-link-btn:hover{border-color:var(--blue);color:var(--blue);}
.route-btn{display:flex;align-items:center;justify-content:center;gap:9px;background:linear-gradient(135deg,#27ae60,#1e8449);color:white;padding:18px;text-decoration:none;border-radius:13px;font-weight:800;font-size:22px;margin:20px 0;transition:all 0.2s;font-family:'Nunito',sans-serif;}
.route-btn:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(39,174,96,0.35);}
.share-row{display:flex;gap:9px;}
.social-btn{flex:1;border:none;padding:13px 9px;border-radius:10px;cursor:pointer;color:white;font-weight:800;font-size:15px;text-decoration:none;text-align:center;font-family:'Nunito',sans-serif;transition:opacity 0.2s;}
.social-btn:hover{opacity:0.85;}
.demont-banner{background:#fff3cd;border:1.5px solid #ffcc02;border-radius:10px;padding:13px 18px;margin-bottom:22px;font-size:18px;font-weight:700;color:#856404;display:flex;align-items:center;gap:9px;}
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1500;}
.overlay.active{display:block;}
.cmarker{width:26px;height:26px;border-radius:50%;border:2.5px solid rgba(0,0,0,0.15);box-shadow:0 3px 9px rgba(0,0,0,0.25);display:flex;align-items:center;justify-content:center;font-size:11px;}
.cmarker.square{border-radius:4px;}
.cmarker.diamond{border-radius:3px;transform:rotate(45deg);}
.diamond-inner{transform:rotate(-45deg);font-size:10px;}
.cmarker.demont{opacity:0.42;filter:grayscale(1);}
/* ===== GAME ===== */
/* Mode picker */
#game-mode-screen{position:fixed;inset:0;z-index:5000;display:none;flex-direction:column;align-items:center;justify-content:center;background:#0d1117;padding:28px;}
#game-mode-screen.active{display:flex;}
.gm-title{font-family:'Playfair Display',serif;font-size:38px;font-weight:900;color:var(--gold);margin-bottom:8px;text-align:center;}
.gm-sub{font-size:16px;color:#8899aa;font-weight:700;margin-bottom:36px;text-align:center;}
.gm-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;width:100%;max-width:520px;}
.gm-card{background:#161b24;border:1.5px solid #1e2d45;border-radius:16px;padding:24px 18px;cursor:pointer;text-align:center;transition:all 0.2s;display:flex;flex-direction:column;align-items:center;gap:8px;}
.gm-card:hover{border-color:var(--gold);transform:translateY(-3px);box-shadow:0 8px 30px rgba(255,215,0,0.15);}
.gm-card .gm-icon{font-size:40px;line-height:1;}
.gm-card .gm-name{font-size:17px;font-weight:900;color:white;}
.gm-card .gm-count{font-size:13px;color:#5d7a9a;font-weight:700;}
.gm-close-row{margin-top:24px;}
.gm-cancel{background:rgba(255,255,255,0.07);color:#8899aa;border:1px solid #2a3545;padding:10px 24px;border-radius:10px;cursor:pointer;font-size:14px;font-weight:700;font-family:'Nunito',sans-serif;transition:all 0.2s;}
.gm-cancel:hover{background:rgba(255,255,255,0.13);color:white;}

/* Main game overlay */
#game-overlay{position:fixed;inset:0;z-index:5000;display:none;flex-direction:column;background:#0d1117;}
#game-overlay.active{display:flex;}
.game-header{background:#0d1117;color:white;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #1e2530;flex-shrink:0;gap:12px;}
.game-logo{font-family:'Playfair Display',serif;font-size:18px;font-weight:900;color:var(--gold);white-space:nowrap;}
.game-mode-badge{background:#1e2d45;color:#8899aa;border-radius:20px;padding:3px 12px;font-size:12px;font-weight:800;letter-spacing:0.3px;}
.game-score-bar{display:flex;align-items:center;gap:14px;flex:1;justify-content:flex-end;}
.game-round-lbl{font-size:13px;font-weight:700;color:#8899aa;}
.game-pts{font-size:20px;font-weight:900;color:var(--gold);font-family:'Playfair Display',serif;}
.game-close{background:rgba(255,255,255,0.08);border:none;color:white;font-size:20px;width:36px;height:36px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.2s;flex-shrink:0;}
.game-close:hover{background:rgba(255,255,255,0.18);}

/* Progress dots */
.game-progress{display:flex;gap:6px;align-items:center;}
.prog-dot{width:10px;height:10px;border-radius:50%;background:#1e2d45;transition:all 0.3s;}
.prog-dot.done{background:#27a465;}
.prog-dot.current{background:var(--gold);transform:scale(1.3);}

/* Body layout */
.game-body{flex:1;display:grid;grid-template-columns:1fr 1fr;overflow:hidden;}

/* Body layout */
.game-body{flex:1;display:grid;grid-template-columns:1fr 1fr;overflow:hidden;min-height:0;}

/* LEFT: photo side */
.game-photo-side{position:relative;background:#111;overflow:hidden;display:flex;align-items:center;justify-content:center;min-height:0;}
.game-photo{max-width:100%;max-height:100%;width:auto;height:auto;display:block;object-fit:contain;}
.game-hint-box{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,0.88));padding:18px 20px 16px;color:white;pointer-events:none;}
.game-hint-title{font-size:11px;font-weight:800;color:rgba(255,255,255,0.45);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px;}
.game-clues{display:flex;gap:7px;flex-wrap:wrap;}
.game-clue{background:rgba(255,255,255,0.13);border:1px solid rgba(255,255,255,0.2);border-radius:20px;padding:4px 12px;font-size:12px;font-weight:700;color:rgba(255,255,255,0.9);}

/* Answer reveal panel ‚Äî top 50% photo, bottom 50% info */
.game-reveal-panel{position:absolute;inset:0;background:#0d1117;display:none;flex-direction:column;z-index:10;}
.game-reveal-panel.active{display:flex;}
.reveal-img-wrap{height:50%;background:#111;display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;}
.reveal-img{max-width:100%;max-height:100%;width:auto;height:auto;display:block;object-fit:contain;}
.reveal-body{height:50%;overflow-y:auto;padding:12px 16px;display:flex;flex-direction:column;gap:5px;}
.reveal-type-badge{display:inline-block;padding:3px 12px;border-radius:20px;font-size:11px;font-weight:800;text-transform:uppercase;color:white;align-self:flex-start;margin-bottom:2px;}
.reveal-city{font-family:'Playfair Display',serif;font-size:22px;font-weight:900;color:white;line-height:1.2;}
.reveal-country{font-size:13px;font-weight:700;color:var(--gold);margin-bottom:4px;}
.reveal-score-row{display:flex;align-items:center;gap:10px;background:#161b24;border-radius:10px;padding:10px 14px;margin:4px 0;}
.reveal-score-km{font-size:26px;font-weight:900;color:var(--gold);font-family:'Playfair Display',serif;line-height:1;}
.reveal-score-km-lbl{font-size:11px;color:#5d7a9a;font-weight:700;}
.reveal-score-pts{font-size:22px;font-weight:900;color:#27a465;font-family:'Playfair Display',serif;}
.reveal-stars{font-size:20px;letter-spacing:3px;}
.reveal-row{font-size:12px;color:#8899aa;font-weight:600;display:flex;gap:6px;}
.reveal-row b{color:#b0c4de;}
.reveal-desc{font-size:12px;color:#6a7a8a;line-height:1.5;border-top:1px solid #1e2530;padding-top:10px;margin-top:4px;}

/* RIGHT: map side */
.game-map-side{position:relative;}
#game-map{width:100%;height:100%;}
.game-map-prompt{position:absolute;top:14px;left:50%;transform:translateX(-50%);background:#0d1117;color:white;padding:8px 16px;border-radius:20px;font-size:13px;font-weight:800;z-index:1000;pointer-events:none;box-shadow:var(--shadow);white-space:nowrap;}
/* Map search box */
.game-map-search{position:absolute;top:14px;right:14px;z-index:1001;}
.game-map-search-inner{display:flex;gap:6px;align-items:center;}
.game-map-search input{padding:8px 14px;border-radius:20px;border:none;font-size:13px;font-family:'Nunito',sans-serif;font-weight:700;width:180px;outline:none;box-shadow:0 2px 12px rgba(0,0,0,0.25);background:rgba(255,255,255,0.96);color:#2a2d35;}
.game-map-search input::placeholder{color:#bbb;font-weight:600;}
.game-search-results{position:absolute;top:42px;right:0;background:white;border-radius:10px;box-shadow:0 4px 22px rgba(0,0,0,0.22);min-width:220px;max-height:220px;overflow-y:auto;display:none;z-index:1002;}
.game-search-results.open{display:block;}
.game-search-item{padding:9px 14px;font-size:13px;font-weight:700;cursor:pointer;border-bottom:1px solid #f0f2f8;color:#2a2d35;transition:background 0.12s;display:flex;flex-direction:column;gap:2px;}
.game-search-item:last-child{border-bottom:none;}
.game-search-item:hover{background:#f0f7ff;color:var(--blue);}
.game-search-item .gsub{font-size:11px;color:#9099b0;font-weight:600;}

/* Bottom action bar on map */
.game-action-bar{position:absolute;bottom:0;left:0;right:0;z-index:1000;display:flex;gap:0;border-top:1px solid #1e2530;}
.game-action-bar button{flex:1;padding:14px 10px;border:none;cursor:pointer;font-size:14px;font-weight:900;font-family:'Nunito',sans-serif;transition:all 0.2s;letter-spacing:0.2px;}
.btn-confirm{background:var(--gold);color:#000;}
.btn-confirm:hover:not(:disabled){background:#e5c200;}
.btn-confirm:disabled{background:#2a3545;color:#4a5a6a;cursor:default;}
.btn-reveal{background:#1a2535;color:#8899aa;border-right:1px solid #1e2530!important;}
.btn-reveal.enabled{color:#6aafff;}
.btn-reveal.enabled:hover{background:#1e2d45;}
.btn-next{background:#0057b7;color:white;}
.btn-next:hover{background:#0049a0;}
.btn-show-answer{background:#1a2535;color:#6aafff;display:none;border-right:1px solid #1e2530!important;}
.btn-show-answer.visible{display:block;}
.btn-show-answer:hover{background:#1e2d45;}

/* Final screen */
.game-final{position:fixed;inset:0;z-index:6000;background:#0d1117;display:none;flex-direction:column;align-items:center;justify-content:center;padding:28px;text-align:center;overflow-y:auto;}
.game-final.active{display:flex;}
.final-title{font-family:'Playfair Display',serif;font-size:40px;font-weight:900;color:var(--gold);margin-bottom:6px;}
.final-subtitle{font-size:17px;color:#8899aa;font-weight:700;margin-bottom:24px;}
.final-total{font-family:'Playfair Display',serif;font-size:76px;font-weight:900;color:white;line-height:1;}
.final-total-lbl{font-size:16px;color:#8899aa;font-weight:700;margin-top:4px;margin-bottom:22px;}
.final-rounds{display:flex;flex-direction:column;gap:8px;width:100%;max-width:400px;margin-bottom:24px;}
.final-round-row{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.05);border-radius:10px;padding:10px 14px;font-size:14px;font-weight:700;color:white;gap:8px;}
.final-round-row .rdist{color:#5d7a9a;white-space:nowrap;}
.final-round-row .rpts{color:var(--gold);white-space:nowrap;}
.final-round-row .rcity{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:left;}
.final-btns{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;}
.final-btn{padding:13px 28px;border-radius:12px;font-size:16px;font-weight:900;cursor:pointer;border:none;font-family:'Nunito',sans-serif;transition:all 0.2s;}
.final-btn.primary{background:var(--gold);color:#000;}
.final-btn.primary:hover{background:#e5c200;}
.final-btn.secondary{background:rgba(255,255,255,0.08);color:white;border:1px solid #2a3545;}
.final-btn.secondary:hover{background:rgba(255,255,255,0.14);}

/* nav on object page */
.page-nav-row{display:flex;gap:9px;margin-bottom:26px;flex-wrap:wrap;align-items:center;}
.page-nav-btn{display:inline-flex;align-items:center;gap:7px;padding:10px 18px;border:1.5px solid #e0e3eb;background:white;border-radius:9px;cursor:pointer;font-weight:700;font-size:15px;font-family:'Nunito',sans-serif;transition:all 0.2s;color:var(--text);}
.page-nav-btn:hover{border-color:var(--blue);color:var(--blue);}
.page-nav-btn.primary{background:var(--blue);color:white;border-color:var(--blue);}
.page-nav-btn.primary:hover{background:#0049a0;}
.page-nav-btn.gold{background:var(--gold-dark);color:white;border-color:var(--gold-dark);}
.page-nav-btn.gold:hover{background:#a07008;}
.page-nav-btn:disabled{opacity:0.4;cursor:default;pointer-events:none;}
.page-nav-pos{font-size:14px;color:var(--muted);font-weight:700;padding:0 4px;}
@media(max-width:800px){
  .game-body{grid-template-columns:1fr;grid-template-rows:42vh 1fr;}
  .game-photo-side{height:42vh;}
  .reveal-img{height:140px;}
  .gm-grid{grid-template-columns:1fr 1fr;}
  .gm-title{font-size:26px;}
  .final-total{font-size:52px;}
  .final-btn{padding:11px 18px;font-size:14px;}
  #sidebar{position:fixed;top:0;left:0;height:100%;width:90%;max-width:380px;transform:translateX(-100%);}
  #sidebar.open{transform:translateX(0);}
  .close-btn{display:block;}
  .mobile-menu-btn{display:flex;}
  .leaflet-popup-content{width:310px !important;}
  .popup-desc{display:none;}
  .grid-main{grid-template-columns:1fr;}
  .page-content{padding:18px 14px;}
  #map-legend{display:none;}
  .map-fab{right:14px;bottom:80px;}
}
</style>
</head>
<body>
<div id="overlay" class="overlay" onclick="toggleSidebar()"></div>
<div id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-top">
      <div style="display:flex;align-items:center;gap:9px">
        <button class="close-btn" onclick="toggleSidebar()">√ó</button>
        <div class="sidebar-title">–®–µ–≤—á–µ–Ω–∫–æ <span>360¬∞</span></div>
      </div>
      <button class="btn-reset" onclick="resetFilters()">‚Ü∫ –°–∫–∏–Ω—É—Ç–∏</button>
    </div>
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('filters',this)">üîç –§—ñ–ª—å—Ç—Ä–∏</button>
      <button class="tab-btn" onclick="switchTab('list',this)">üìã –°–ø–∏—Å–æ–∫</button>
      <button class="tab-btn" onclick="switchTab('stats',this)">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
    </div>
  </div>
  <div id="tab-filters" class="tab-panel active">
    <div class="filter-section">
      <div class="filter-label">üîé –ü–æ—à—É–∫</div>
      <input type="text" id="search" placeholder="–ú—ñ—Å—Ç–æ, –∫—Ä–∞—ó–Ω–∞, –∞–≤—Ç–æ—Ä...">
    </div>
    <div class="filter-section">
      <div class="filter-label">üåç –ö—Ä–∞—ó–Ω–∞</div>
      <div id="countryTags" class="tag-scroll"></div>
      <div id="regionPanel">
        <div class="filter-label" style="font-size:13px;color:var(--blue);margin-bottom:7px;margin-top:4px">üìç –û–±–ª–∞—Å—Ç—å</div>
        <div id="regionTags" class="tag-scroll"></div>
      </div>
    </div>
    <div class="filter-section">
      <div class="filter-label">üóø –¢–∏–ø –æ–±'—î–∫—Ç–∞</div>
      <div id="typeTags" class="tag-container"></div>
    </div>
    <div class="filter-section">
      <div class="filter-label">üëÅ –í–∏–≥–ª—è–¥ (—Ç–∞–∫—Å–æ–Ω–æ–º—ñ—è)</div>
      <div id="viewTags" class="tag-container"></div>
    </div>
    <div class="filter-section">
      <div class="filter-label">üìÖ –†–æ–∫–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è</div>
      <div class="range-wrap">
        <div class="range-track-bg"></div>
        <div class="range-track-fill" id="rangeTrack"></div>
        <input type="range" id="yearMin" min="1860" max="2025" value="1860" step="1">
        <input type="range" id="yearMax" min="1860" max="2025" value="2025" step="1">
        <div class="range-labels"><span id="yearMinLbl">1860</span><span id="yearMaxLbl">2025</span></div>
      </div>
    </div>
    <div class="filter-section">
      <div class="filter-label">üé® –°–∫—É–ª—å–ø—Ç–æ—Ä</div>
      <div class="autocomplete-wrap">
        <input type="text" id="sculptorInput" list="sculptorList" placeholder="–Ü–º'—è —Å–∫—É–ª—å–ø—Ç–æ—Ä–∞...">
        <button id="sculptorClear" onclick="clearSculptor()">√ó</button>
        <datalist id="sculptorList"></datalist>
      </div>
    </div>
    <div class="filter-section">
      <div class="filter-label">‚öôÔ∏è –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ñ—ñ–ª—å—Ç—Ä–∏</div>
      <div class="seg-group">
        <div>
          <div class="seg-label">üì∏ –§–æ—Ç–æ</div>
          <div class="seg-ctrl" id="photoCtrl">
            <button class="seg-btn active" data-val="all" onclick="setSegment('photo','all',this)">–í—Å—ñ</button>
            <button class="seg-btn" data-val="with" onclick="setSegment('photo','with',this)">–ó —Ñ–æ—Ç–æ</button>
            <button class="seg-btn" data-val="without" onclick="setSegment('photo','without',this)">–ë–µ–∑ —Ñ–æ—Ç–æ</button>
          </div>
        </div>
        <div>
          <div class="seg-label">üö´ –î–µ–º–æ–Ω—Ç–æ–≤–∞–Ω—ñ</div>
          <div class="seg-ctrl" id="demontCtrl">
            <button class="seg-btn active" data-val="hide" onclick="setSegment('demont','hide',this)">–ë–µ–∑ –Ω–∏—Ö</button>
            <button class="seg-btn" data-val="show" onclick="setSegment('demont','show',this)">+ –ü–æ–∫–∞–∑–∞—Ç–∏</button>
            <button class="seg-btn" data-val="only" onclick="setSegment('demont','only',this)">–¢—ñ–ª—å–∫–∏</button>
          </div>
        </div>
        <div class="toggle-row">
          <div class="toggle-label">üìö –¢—ñ–ª—å–∫–∏ –∑ –í—ñ–∫—ñ–ø–µ–¥—ñ—î—é</div>
          <label class="toggle"><input type="checkbox" id="toggleWiki" onchange="renderMap()"><span class="slider-toggle"></span></label>
        </div>
      </div>
    </div>
  </div>
  <div id="tab-list" class="tab-panel">
    <div class="list-toolbar"><div class="list-count" id="listCount">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div></div>
    <div id="listGrid" class="list-grid"></div>
  </div>
  <div id="tab-stats" class="tab-panel">
    <div class="stat-card"><div class="stat-card-title">üìå –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div><div class="stat-numbers" id="statsNumbers"></div></div>
    <div class="stat-card"><div class="stat-card-title">üåç –¢–æ–ø –∫—Ä–∞—ó–Ω</div><div id="statsCountries" class="bar-chart"></div></div>
    <div class="stat-card"><div class="stat-card-title">üóø –†–æ–∑–ø–æ–¥—ñ–ª –∑–∞ —Ç–∏–ø–æ–º</div><div id="statsTypes" class="donut-legend"></div></div>
    <div class="stat-card"><div class="stat-card-title">üìÖ –ü–æ –¥–µ—Å—è—Ç–∏–ª—ñ—Ç—Ç—è—Ö</div><div id="statsDecades" class="decade-chart"></div></div>
    <div class="stat-card"><div class="stat-card-title">‚úÖ –ü–æ–≤–Ω–æ—Ç–∞ –¥–∞–Ω–∏—Ö</div><div id="statsCompleteness" class="completeness-bars"></div></div>
  </div>
  <div id="counter">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
</div>
<div id="map-container">
  <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞ –§—ñ–ª—å—Ç—Ä–∏</button>
  <div id="map"></div>
  <div class="map-fab">
    <button class="map-btn" id="btnGeo" onclick="geolocate()">üìç<span class="map-btn-tooltip">–ú–æ—î –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è</span></button>
    <button class="map-btn" onclick="openRandom()">üé≤<span class="map-btn-tooltip">–í–∏–ø–∞–¥–∫–æ–≤–∏–π –æ–±'—î–∫—Ç</span></button>
    <button class="map-btn" id="btnGameStart" onclick="showGameModes()" title="" style="opacity:0.4;pointer-events:none">üéØ<span class="map-btn-tooltip">–í—ñ–¥–≥–∞–¥–∞–π –¥–µ!</span></button>
  </div>
  <div id="map-legend"><div style="font-size:11px;font-weight:800;color:#9099b0;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:7px">–¢–∏–ø –æ–±'—î–∫—Ç–∞</div></div>
</div>
<div id="object-page">
  <div class="page-content">
    <div class="page-nav-row" id="pageNavRow">
      <button class="page-nav-btn" onclick="closePage()">‚Üê –ù–∞–∑–∞–¥</button>
      <button class="page-nav-btn" id="btnPrev" onclick="navObject(-1)">‚Äπ –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π</button>
      <span class="page-nav-pos" id="navPos"></span>
      <button class="page-nav-btn" id="btnNext" onclick="navObject(1)">–ù–∞—Å—Ç—É–ø–Ω–∏–π ‚Ä∫</button>
      <button class="page-nav-btn gold" onclick="openRandom()">üé≤ –í–∏–ø–∞–¥–∫–æ–≤–∏–π</button>
    </div>
    <div id="details"></div>
  </div>
</div>

<!-- GAME MODE SELECTOR -->
<div id="game-mode-screen">
  <div class="gm-title">üóø –í—ñ–¥–≥–∞–¥–∞–π –¥–µ!</div>
  <div class="gm-sub">–û–±–µ—Ä–∏ –≥–µ–æ–≥—Ä–∞—Ñ—ñ—é –≥—Ä–∏ ‚Äî 5 —Ä–∞—É–Ω–¥—ñ–≤, 25 000 –±–∞–ª—ñ–≤</div>
  <div class="gm-grid" id="gmGrid">
    <div class="gm-card" onclick="startGameMode('world')">
      <div class="gm-icon">üåç</div>
      <div class="gm-name">–í–µ—Å—å —Å–≤—ñ—Ç</div>
      <div class="gm-count" id="gmCount-world">...</div>
    </div>
    <div class="gm-card" onclick="startGameMode('ukraine')">
      <div class="gm-icon">üá∫üá¶</div>
      <div class="gm-name">–£–∫—Ä–∞—ó–Ω–∞</div>
      <div class="gm-count" id="gmCount-ukraine">...</div>
    </div>
    <div class="gm-card" onclick="startGameMode('abroad')">
      <div class="gm-icon">‚úàÔ∏è</div>
      <div class="gm-name">–ó–∞–∫–æ—Ä–¥–æ–Ω–Ω—è</div>
      <div class="gm-count" id="gmCount-abroad">...</div>
    </div>
    <div class="gm-card" onclick="startGameMode('ternopil')">
      <div class="gm-icon">üåª</div>
      <div class="gm-name">–¢–µ—Ä–Ω–æ–ø—ñ–ª–ª—è</div>
      <div class="gm-count" id="gmCount-ternopil">...</div>
    </div>
  </div>
  <div class="gm-close-row">
    <button class="gm-cancel" onclick="closeGame()">‚Üê –ù–∞–∑–∞–¥ –Ω–∞ –∫–∞—Ä—Ç—É</button>
  </div>
</div>

<!-- GAME OVERLAY -->
<div id="game-overlay">
  <div class="game-header">
    <div style="display:flex;align-items:center;gap:10px">
      <div class="game-logo">üóø –í—ñ–¥–≥–∞–¥–∞–π –¥–µ!</div>
      <div class="game-mode-badge" id="gameModeBadge"></div>
    </div>
    <div class="game-score-bar">
      <div class="game-progress" id="gameDots"></div>
      <span class="game-round-lbl" id="gameRoundLbl">–†–∞—É–Ω–¥ 1 / 5</span>
      <span class="game-pts" id="gameTotalPts">0 –±–∞–ª—ñ–≤</span>
    </div>
    <button class="game-close" onclick="closeGame()" title="–ó–∞–∫—Ä–∏—Ç–∏">‚úï</button>
  </div>
  <div class="game-body">
    <!-- LEFT: photo + reveal -->
    <div class="game-photo-side">
      <img id="gamePhoto" class="game-photo" src="" alt="">
      <div class="game-hint-box">
        <div class="game-hint-title">–ü—ñ–¥–∫–∞–∑–∫–∏</div>
        <div class="game-clues" id="gameClues"></div>
      </div>
      <!-- Answer reveal panel -->
      <div class="game-reveal-panel" id="gameRevealPanel">
        <div class="reveal-img-wrap">
          <img id="revealImg" class="reveal-img" src="" alt="">
        </div>
        <div class="reveal-body">
          <span class="reveal-type-badge" id="revealTypeBadge"></span>
          <div class="reveal-city" id="revealCity"></div>
          <div class="reveal-country" id="revealCountry"></div>
          <div class="reveal-score-row">
            <div>
              <div class="reveal-score-km" id="revealKm"></div>
              <div class="reveal-score-km-lbl">–∫–º –≤—ñ–¥ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ</div>
            </div>
            <div style="flex:1;text-align:right">
              <div class="reveal-score-pts" id="revealPts"></div>
              <div class="reveal-stars" id="revealStars"></div>
            </div>
          </div>
          <div class="reveal-row" id="revealYear"></div>
          <div class="reveal-row" id="revealSculptor"></div>
          <div class="reveal-row" id="revealMaterial"></div>
          <div class="reveal-desc" id="revealDesc"></div>
        </div>
      </div>
    </div>
    <!-- RIGHT: map -->
    <div class="game-map-side">
      <div class="game-map-prompt" id="gameMapPrompt">üëÜ –ö–ª—ñ–∫–Ω–∏ –¥–µ —Å—Ç–æ—ó—Ç—å —Ü–µ–π –ø–∞–º'—è—Ç–Ω–∏–∫</div>
      <!-- Map navigation search -->
      <div class="game-map-search" id="gameMapSearch">
        <div class="game-map-search-inner">
          <input type="text" id="gameSearchInput" placeholder="üîé –ó–Ω–∞–π—Ç–∏ –∫—Ä–∞—ó–Ω—É / –º—ñ—Å—Ç–æ..." autocomplete="off" oninput="onGameSearch(this.value)" onkeydown="onGameSearchKey(event)">
        </div>
        <div class="game-search-results" id="gameSearchResults"></div>
      </div>
      <div id="game-map"></div>
      <div class="game-action-bar" id="gameActionBar">
        <button class="btn-reveal" id="btnReveal" onclick="showAnswer()" disabled>üìç –ü–æ–∫–∞–∑–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å</button>
        <button class="btn-confirm" id="btnConfirm" disabled onclick="confirmGuess()">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ ‚Ä∫</button>
        <button class="btn-next" id="gameNextBtn" onclick="nextRound()" style="display:none">–î–∞–ª—ñ ‚Ä∫</button>
      </div>
    </div>
  </div>
</div>

<!-- FINAL SCREEN -->
<div class="game-final" id="gameFinal">
  <div class="final-title">–ì—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</div>
  <div class="final-subtitle" id="finalSubtitle"></div>
  <div class="final-total" id="finalTotal"></div>
  <div class="final-total-lbl">–±–∞–ª—ñ–≤ –∑ 25 000 –º–æ–∂–ª–∏–≤–∏—Ö</div>
  <div class="final-rounds" id="finalRounds"></div>
  <div class="final-btns">
    <button class="final-btn primary" onclick="showGameModes()">üéØ –ì—Ä–∞—Ç–∏ –∑–Ω–æ–≤—É</button>
    <button class="final-btn secondary" onclick="closeGame()">‚Üê –ù–∞ –∫–∞—Ä—Ç—É</button>
  </div>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
const map=L.map('map',{zoomControl:false}).setView([48.5,31.2],5);
L.control.zoom({position:'bottomright'}).addTo(map);
L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{attribution:'¬© OpenStreetMap contributors ¬© CARTO'}).addTo(map);
const markersCluster=L.markerClusterGroup({showCoverageOnHover:false,maxClusterRadius:50});
map.addLayer(markersCluster);

const TYPE_CONFIG={
  "–ø–∞–º'—è—Ç–Ω–∏–∫":{color:'#0057b7',shape:'round',label:"–ü–∞–º'—è—Ç–Ω–∏–∫"},
  '–ø–æ–≥—Ä—É–¥–¥—è':{color:'#c8900a',shape:'round',label:'–ü–æ–≥—Ä—É–¥–¥—è'},
  '–º–µ–º–æ—Ä—ñ–∞–ª—å–Ω–∞ –¥–æ—à–∫–∞':{color:'#27a465',shape:'square',label:'–ú–µ–º. –¥–æ—à–∫–∞'},
  '–±–∞—Ä–µ–ª—å—î—Ñ':{color:'#8e44ad',shape:'diamond',label:'–ë–∞—Ä–µ–ª—å—î—Ñ'},
  "–ø–∞–º'—è—Ç–Ω–∏–π –∑–Ω–∞–∫":{color:'#e04040',shape:'round',label:"–ü–∞–º. –∑–Ω–∞–∫"},
  '—Å—Ç–µ–ª–∞':{color:'#16a085',shape:'round',label:'–°—Ç–µ–ª–∞'},
  '—Å–∫—É–ª—å–ø—Ç—É—Ä–∞':{color:'#d35400',shape:'round',label:'–°–∫—É–ª—å–ø—Ç—É—Ä–∞'},
  '–º–µ–º–æ—Ä—ñ–∞–ª—å–Ω–∞ –¥–æ—à–∫–∞-–±–∞—Ä–µ–ª—å—î—Ñ':{color:'#5d6d7e',shape:'square',label:'–î–æ—à–∫–∞-–±–∞—Ä–µ–ª—å—î—Ñ'},
  "–ø–∞–º'—è—Ç–Ω–∏–π —Ö—Ä–µ—Å—Ç":{color:'#922b21',shape:'round',label:"–ü–∞–º. —Ö—Ä–µ—Å—Ç"},
  '–º—ñ–Ω—ñ–∞—Ç—é—Ä–∞':{color:'#f0b429',shape:'round',label:'–ú—ñ–Ω—ñ–∞—Ç—é—Ä–∞'},
  '–≥–æ—Ä–µ–ª—å—î—Ñ':{color:'#2471a3',shape:'round',label:'–ì–æ—Ä–µ–ª—å—î—Ñ'},
  'default':{color:'#7a8090',shape:'round',label:'–Ü–Ω—à–µ'},
};
const getTypeConf=t=>TYPE_CONFIG[t]||TYPE_CONFIG.default;

function createIcon(type,isDemolished){
  const conf=getTypeConf(type);
  const color=isDemolished?'#888':conf.color;
  const shape=isDemolished?'round':conf.shape;
  const cls='cmarker'+(shape==='square'?' square':'')+(shape==='diamond'?' diamond':'')+(isDemolished?' demont':'');
  const inner=shape==='diamond'?'<div class="diamond-inner">‚óÜ</div>':'';
  return L.divIcon({html:'<div class="'+cls+'" style="background:'+color+'">'+inner+'</div>',className:'',iconSize:[26,26],iconAnchor:[13,13],popupAnchor:[0,-15]});
}

function buildLegend(){
  const leg=document.getElementById('map-legend');
  const used=new Set(rawData.map(i=>getVal(i,'type')));
  Object.entries(TYPE_CONFIG).forEach(([type,conf])=>{
    if(type==='default'||!used.has(type))return;
    const d=document.createElement('div');d.className='leg-item';
    d.innerHTML='<div class="leg-marker '+(conf.shape==='square'?'square':conf.shape==='diamond'?'diamond':'')+'" style="background:'+conf.color+'"></div><span>'+conf.label+'</span>';
    leg.appendChild(d);
  });
  const dd=document.createElement('div');dd.className='leg-item';
  dd.innerHTML='<div class="leg-marker demont" style="background:#888"></div><span>–î–µ–º–æ–Ω—Ç–æ–≤–∞–Ω–∏–π</span>';
  leg.appendChild(dd);
}

const csvUrl='https://docs.google.com/spreadsheets/d/e/2PACX-1vTxfvvWkJdsGNJBOWM3oftjwmKf4xe6q4xOqrztdTmLSYskX49VhYzU6CCzPNRFWHojuW59X4sxlbrY/pub?output=csv';
let rawData=[],activeType='all',activeView='all',activeCountry='all',activeRegion='all';
let yearMin=1860,yearMax=2025,photoMode='all',demontMode='hide',currentFiltered=[];

const getVal=(obj,key)=>{if(!obj)return'';const k=Object.keys(obj).find(k=>k.trim().toLowerCase()===key.trim().toLowerCase());return k?(obj[k]||'').trim():'';};
const extractYear=str=>{if(!str)return null;const m=str.match(/\d{4}/);return m?parseInt(m[0]):null;};
const NO_PHOTO_SVG="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'%3E%3Crect width='120' height='120' fill='%23ebeef5'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='36' fill='%23b0b8cc'%3Eüóø%3C/text%3E%3C/svg%3E";

Papa.parse(csvUrl,{download:true,header:true,skipEmptyLines:true,
  complete:r=>{rawData=r.data.filter(i=>getVal(i,'lat'));init();},
  error:()=>{document.getElementById('counter').innerText='–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è';}
});

function init(){
  buildCountryTags();
  buildSculptorList();
  initYearSlider();
  buildLegend();
  loadUrlParams();
  buildStats();
  updateGameModeCounts(); // —Ä–∞—Ö—É—î–º–æ –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
  // –≤–º–∏–∫–∞—î–º–æ –∫–Ω–æ–ø–∫—É –≥—Ä–∏
  const gb=document.getElementById('btnGameStart');
  if(gb){gb.style.opacity='';gb.style.pointerEvents='';}
  renderMap();
  const id=new URLSearchParams(window.location.search).get('id');
  if(id)openPage(id);
}

function buildCountryTags(){
  const cC={};
  rawData.forEach(i=>{const c=getVal(i,'Country');if(c)cC[c]=(cC[c]||0)+1;});
  const sorted=Object.keys(cC).sort((a,b)=>{
    if(a==='–£–∫—Ä–∞—ó–Ω–∞'||a==='Ukraine')return -1;
    if(b==='–£–∫—Ä–∞—ó–Ω–∞'||b==='Ukraine')return 1;
    return cC[b]-cC[a];
  });
  const ct=document.getElementById('countryTags');ct.innerHTML='';
  const allRow=document.createElement('div');allRow.className='tag-scroll-item active';allRow.dataset.val='all';
  allRow.innerHTML='<span>üåê –£—Å—ñ –∫—Ä–∞—ó–Ω–∏</span><span class="cnt-badge">'+rawData.length+'</span>';
  allRow.onclick=()=>selectCountry('all');ct.appendChild(allRow);
  sorted.forEach(c=>{
    const row=document.createElement('div');row.className='tag-scroll-item';row.dataset.val=c;
    row.innerHTML='<span>'+c+'</span><span class="cnt-badge">'+cC[c]+'</span>';
    row.onclick=()=>selectCountry(c);ct.appendChild(row);
  });
  buildRegionTags();
}

function buildRegionTags(){
  const rC={};
  rawData.filter(i=>getVal(i,'Country').includes('–£–∫—Ä–∞—ó–Ω–∞')||getVal(i,'Country')==='Ukraine')
    .forEach(i=>{const r=getVal(i,'Region');if(r)rC[r]=(rC[r]||0)+1;});
  const sorted=Object.keys(rC).sort((a,b)=>rC[b]-rC[a]);
  const rt=document.getElementById('regionTags');rt.innerHTML='';
  const allRow=document.createElement('div');allRow.className='tag-scroll-item active';allRow.dataset.val='all';
  allRow.innerHTML='<span>–í—Å—ñ –æ–±–ª–∞—Å—Ç—ñ</span><span class="cnt-badge">'+Object.values(rC).reduce((a,b)=>a+b,0)+'</span>';
  allRow.onclick=()=>selectRegion('all');rt.appendChild(allRow);
  sorted.forEach(r=>{
    const row=document.createElement('div');row.className='tag-scroll-item';row.dataset.val=r;
    row.innerHTML='<span>'+r+'</span><span class="cnt-badge">'+rC[r]+'</span>';
    row.onclick=()=>selectRegion(r);rt.appendChild(row);
  });
}

function selectCountry(val){
  activeCountry=val;activeRegion='all';
  document.querySelectorAll('#countryTags .tag-scroll-item').forEach(el=>el.classList.toggle('active',el.dataset.val===val));
  const isUa=val!=='all'&&(val.includes('–£–∫—Ä–∞—ó–Ω–∞')||val.toLowerCase()==='ukraine');
  document.getElementById('regionPanel').style.display=isUa?'block':'none';
  document.querySelectorAll('#regionTags .tag-scroll-item').forEach(el=>el.classList.toggle('active',el.dataset.val==='all'));
  if(val!=='all'){
    const pts=rawData.filter(i=>getVal(i,'Country')===val).map(i=>[parseFloat(getVal(i,'lat').replace(',','.')),parseFloat(getVal(i,'lon').replace(',','.'))]).filter(p=>!isNaN(p[0])&&!isNaN(p[1]));
    if(pts.length===1)map.setView(pts[0],12);
    else if(pts.length>1)map.fitBounds(pts,{padding:[40,40],maxZoom:10});
  }else{map.setView([48.5,31.2],5);}
  updateUrlParams();renderMap();
}

function selectRegion(val){
  activeRegion=val;
  document.querySelectorAll('#regionTags .tag-scroll-item').forEach(el=>el.classList.toggle('active',el.dataset.val===val));
  if(val!=='all'){
    const pts=rawData.filter(i=>getVal(i,'Region')===val).map(i=>[parseFloat(getVal(i,'lat').replace(',','.')),parseFloat(getVal(i,'lon').replace(',','.'))]).filter(p=>!isNaN(p[0])&&!isNaN(p[1]));
    if(pts.length===1)map.setView(pts[0],13);
    else if(pts.length>1)map.fitBounds(pts,{padding:[40,40],maxZoom:11});
  }
  updateUrlParams();renderMap();
}

function setSegment(which,val,btn){
  const id=which==='photo'?'photoCtrl':'demontCtrl';
  document.querySelectorAll('#'+id+' .seg-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  if(which==='photo')photoMode=val;else demontMode=val;
  updateUrlParams();renderMap();
}

function buildSculptorList(){
  const s=new Set();
  rawData.forEach(i=>{const v=getVal(i,'sculptor');if(v&&!['–ù–µ–≤—ñ–¥–æ–º–∏–π','–Ω–µ–≤—ñ–¥–æ–º–∏–π','–º–∞—Å–æ–≤–µ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ'].includes(v))s.add(v);});
  const dl=document.getElementById('sculptorList');
  [...s].sort().forEach(v=>{const o=document.createElement('option');o.value=v;dl.appendChild(o);});
  document.getElementById('sculptorInput').addEventListener('input',()=>{
    document.getElementById('sculptorClear').style.display=document.getElementById('sculptorInput').value?'block':'none';
    renderMap();
  });
}
function clearSculptor(){document.getElementById('sculptorInput').value='';document.getElementById('sculptorClear').style.display='none';renderMap();}

function initYearSlider(){
  const minI=document.getElementById('yearMin'),maxI=document.getElementById('yearMax');
  const track=document.getElementById('rangeTrack'),minL=document.getElementById('yearMinLbl'),maxL=document.getElementById('yearMaxLbl');
  const MIN=1860,MAX=2025;
  function upd(){
    let lo=parseInt(minI.value),hi=parseInt(maxI.value);
    if(lo>hi){if(this===minI)lo=hi;else hi=lo;minI.value=lo;maxI.value=hi;}
    yearMin=lo;yearMax=hi;minL.textContent=lo;maxL.textContent=hi;
    const plo=((lo-MIN)/(MAX-MIN))*100,phi=((hi-MIN)/(MAX-MIN))*100;
    track.style.left=plo+'%';track.style.right=(100-phi)+'%';
    updateUrlParams();renderMap();
  }
  minI.addEventListener('input',upd);maxI.addEventListener('input',upd);upd.call(minI);
}

function updateUrlParams(){
  const p=new URLSearchParams();
  const s=document.getElementById('search').value,sc=document.getElementById('sculptorInput').value;
  if(s)p.set('q',s);
  if(activeCountry!=='all')p.set('country',activeCountry);
  if(activeRegion!=='all')p.set('region',activeRegion);
  if(activeType!=='all')p.set('type',activeType);
  if(activeView!=='all')p.set('view',activeView);
  if(yearMin!==1860)p.set('ymin',yearMin);
  if(yearMax!==2025)p.set('ymax',yearMax);
  if(sc)p.set('sculptor',sc);
  if(photoMode!=='all')p.set('photo',photoMode);
  if(demontMode!=='hide')p.set('demont',demontMode);
  const str=p.toString();
  window.history.replaceState({},'',(str?'?'+str:window.location.pathname));
}

function loadUrlParams(){
  const p=new URLSearchParams(window.location.search);
  if(p.get('q'))document.getElementById('search').value=p.get('q');
  if(p.get('country')){activeCountry=p.get('country');selectCountry(activeCountry);}
  if(p.get('region')){activeRegion=p.get('region');selectRegion(activeRegion);}
  if(p.get('type'))activeType=p.get('type');
  if(p.get('view'))activeView=p.get('view');
  if(p.get('ymin')){document.getElementById('yearMin').value=p.get('ymin');yearMin=parseInt(p.get('ymin'));document.getElementById('yearMinLbl').textContent=yearMin;}
  if(p.get('ymax')){document.getElementById('yearMax').value=p.get('ymax');yearMax=parseInt(p.get('ymax'));document.getElementById('yearMaxLbl').textContent=yearMax;}
  if(p.get('sculptor')){document.getElementById('sculptorInput').value=p.get('sculptor');document.getElementById('sculptorClear').style.display='block';}
  if(p.get('photo')){photoMode=p.get('photo');document.querySelectorAll('#photoCtrl .seg-btn').forEach(b=>b.classList.toggle('active',b.dataset.val===photoMode));}
  if(p.get('demont')){demontMode=p.get('demont');document.querySelectorAll('#demontCtrl .seg-btn').forEach(b=>b.classList.toggle('active',b.dataset.val===demontMode));}
}

function renderMap(){
  markersCluster.clearLayers();
  const s=document.getElementById('search').value.toLowerCase();
  const sc=document.getElementById('sculptorInput').value.toLowerCase();
  const onlyWiki=document.getElementById('toggleWiki').checked;
  const filtered=rawData.filter(item=>{
    const isDem=!!getVal(item,'year_demont');
    if(demontMode==='hide'&&isDem)return false;
    if(demontMode==='only'&&!isDem)return false;
    if(activeCountry!=='all'&&getVal(item,'Country')!==activeCountry)return false;
    if(activeRegion!=='all'&&getVal(item,'Region')!==activeRegion)return false;
    if(activeType!=='all'&&getVal(item,'type')!==activeType)return false;
    if(activeView!=='all'){const vs=getVal(item,'view').split(',').map(v=>v.trim());if(!vs.includes(activeView))return false;}
    const yr=extractYear(getVal(item,'year_start'));
    if(yr&&(yr<yearMin||yr>yearMax))return false;
    if(sc&&!getVal(item,'sculptor').toLowerCase().includes(sc))return false;
    const hasPhoto=!!(getVal(item,'Photo-GM')||getVal(item,'other photo link'));
    if(photoMode==='with'&&!hasPhoto)return false;
    if(photoMode==='without'&&hasPhoto)return false;
    if(onlyWiki&&!getVal(item,'Wikipedia'))return false;
    if(s){const pool=(getVal(item,'City')+' '+getVal(item,'Country')+' '+getVal(item,'Region')+' '+getVal(item,'Street')+' '+getVal(item,'adr')+' '+getVal(item,'sculptor')+' '+getVal(item,'short description')).toLowerCase();if(!pool.includes(s))return false;}
    return true;
  });
  currentFiltered=filtered;
  filtered.forEach(item=>{
    const lat=parseFloat(getVal(item,'lat').replace(',','.'));
    const lon=parseFloat(getVal(item,'lon').replace(',','.'));
    if(isNaN(lat)||isNaN(lon))return;
    const type=getVal(item,'type'),isDem=!!getVal(item,'year_demont'),conf=getTypeConf(type);
    const img=getVal(item,'Photo-GM')||getVal(item,'other photo link');
    let desc=getVal(item,'short description')||'';if(desc.length>120)desc=desc.substring(0,120)+'...';
    const demBadge=isDem?'<div class="popup-demont-badge">‚õî –î–ï–ú–û–ù–¢–û–í–ê–ù–û '+getVal(item,'year_demont')+'</div>':'';
    const pop='<div class="popup-card"><div class="popup-photo-side"><img src="'+(img||NO_PHOTO_SVG)+'" class="popup-photo" onerror="this.src=\''+NO_PHOTO_SVG+'\'"><div class="popup-type-badge" style="background:'+(isDem?'#888':conf.color)+'">'+(type||"–û–±'—î–∫—Ç")+'</div>'+demBadge+'</div><div class="popup-info"><h3 class="popup-title">'+getVal(item,'City')+'</h3><div class="popup-detail">üìç '+getVal(item,'Country')+(getVal(item,'Region')?', '+getVal(item,'Region'):'')+' </div><div class="popup-detail">üìÖ '+(getVal(item,'year_start')||'–†—ñ–∫ –Ω–µ–≤—ñ–¥–æ–º–∏–π')+'</div>'+(getVal(item,'sculptor')?'<div class="popup-detail">üé® '+getVal(item,'sculptor')+'</div>':'')+'<div class="popup-desc">'+desc+'</div><button class="more-btn" onclick="openPage(\''+getVal(item,'id')+'\')">–î–ï–¢–ê–õ–¨–ù–Ü–®–ï ‚Üí</button></div></div>';
    markersCluster.addLayer(L.marker([lat,lon],{icon:createIcon(type,isDem)}).bindPopup(pop,{maxWidth:400}));
  });
  document.getElementById('counter').innerHTML='–ü–æ–∫–∞–∑–∞–Ω–æ: <span>'+filtered.length+'</span> / '+rawData.length+' –æ–±\'—î–∫—Ç—ñ–≤';
  updateTags('type','typeTags',activeType);
  updateTags('view','viewTags',activeView);
  renderList(filtered);
}

function updateTags(key,cId,av){
  const counts={};
  rawData.forEach(i=>{const raw=getVal(i,key);if(!raw)return;if(key==='view'){raw.split(',').forEach(p=>{const t=p.trim();if(t)counts[t]=(counts[t]||0)+1;});}else counts[raw]=(counts[raw]||0)+1;});
  const container=document.getElementById(cId);container.innerHTML='';
  Object.entries(counts).sort((a,b)=>b[1]-a[1]).forEach(([val,cnt])=>{
    const conf=key==='type'?getTypeConf(val):null;
    const btn=document.createElement('div');btn.className='stat-tag'+(av===val?' active':'');
    btn.innerHTML=(conf?'<span class="dot" style="background:'+conf.color+'"></span>':'')+val+'<span class="cnt">'+cnt+'</span>';
    btn.onclick=()=>{if(key==='type')activeType=(activeType===val?'all':val);else activeView=(activeView===val?'all':val);updateUrlParams();renderMap();if(window.innerWidth<=800)toggleSidebar();};
    container.appendChild(btn);
  });
}

function renderList(items){
  const grid=document.getElementById('listGrid');
  document.getElementById('listCount').textContent=items.length+" –æ–±'—î–∫—Ç—ñ–≤";
  grid.innerHTML='';
  if(!items.length){grid.innerHTML='<div class="list-empty">üòî –ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.<br>–ó–º—ñ–Ω—ñ—Ç—å —Ñ—ñ–ª—å—Ç—Ä–∏.</div>';return;}
  items.slice(0,200).forEach(item=>{
    const img=getVal(item,'Photo-GM')||getVal(item,'other photo link');
    const type=getVal(item,'type'),conf=getTypeConf(type),isDem=!!getVal(item,'year_demont');
    const card=document.createElement('div');card.className='list-card';
    card.innerHTML='<img class="list-card-img" src="'+(img||NO_PHOTO_SVG)+'" onerror="this.src=\''+NO_PHOTO_SVG+'\'" loading="lazy"><div class="list-card-body"><div class="list-card-city">'+(getVal(item,'City')||'‚Äî')+'</div><div class="list-card-sub">üìç '+getVal(item,'Country')+(getVal(item,'Region')?', '+getVal(item,'Region'):'')+' </div><div class="list-card-sub">üìÖ '+(getVal(item,'year_start')||'?')+'</div><span class="list-card-type" style="background:'+(isDem?'#888':conf.color)+'">'+(isDem?'–î–µ–º–æ–Ω—Ç–æ–≤–∞–Ω–æ':type||"–û–±'—î–∫—Ç")+'</span></div>';
    card.onclick=()=>openPage(getVal(item,'id'));grid.appendChild(card);
  });
  if(items.length>200){const n=document.createElement('div');n.className='list-empty';n.textContent='... —Ç–∞ —â–µ '+(items.length-200)+' –æ–±\'—î–∫—Ç—ñ–≤. –£—Ç–æ—á–Ω—ñ—Ç—å —Ñ—ñ–ª—å—Ç—Ä–∏.';grid.appendChild(n);}
}

// Helper: –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä –∑—ñ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —ñ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É –§—ñ–ª—å—Ç—Ä–∏
function applyStatFilter(fn){
  fn();
  updateUrlParams();
  renderMap();
  // –ø–µ—Ä–µ–º–∫–Ω—É—Ç–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É –§—ñ–ª—å—Ç—Ä–∏
  switchTab('filters', document.querySelector('.tab-btn'));
}

function buildStats(){
  const total=rawData.length;
  const countries=new Set(rawData.map(i=>getVal(i,'Country'))).size;
  const withPhoto=rawData.filter(i=>getVal(i,'Photo-GM')||getVal(i,'other photo link')).length;
  const demont=rawData.filter(i=>getVal(i,'year_demont')).length;

  // –ß–∏—Å–ª–æ–≤—ñ –±–ª–æ–∫–∏ ‚Äî "–ó —Ñ–æ—Ç–æ" —ñ "–î–µ–º–æ–Ω—Ç–æ–≤–∞–Ω–æ" –∫–ª—ñ–∫–∞–±–µ–ª—å–Ω—ñ
  document.getElementById('statsNumbers').innerHTML=
    `<div class="stat-num-box"><div class="stat-num-val">${total}</div><div class="stat-num-label">–û–±'—î–∫—Ç—ñ–≤</div></div>`+
    `<div class="stat-num-box"><div class="stat-num-val">${countries}</div><div class="stat-num-label">–ö—Ä–∞—ó–Ω</div></div>`+
    `<div class="stat-num-box clickable" title="–ü–æ–∫–∞–∑–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –∑ —Ñ–æ—Ç–æ" onclick="applyStatFilter(()=>{photoMode='with';document.querySelectorAll('#photoCtrl .seg-btn').forEach(b=>b.classList.toggle('active',b.dataset.val==='with'));})"><div class="stat-num-val">${withPhoto}</div><div class="stat-num-label">–ó —Ñ–æ—Ç–æ üëÜ</div></div>`+
    `<div class="stat-num-box clickable" title="–ü–æ–∫–∞–∑–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –¥–µ–º–æ–Ω—Ç–æ–≤–∞–Ω—ñ" onclick="applyStatFilter(()=>{demontMode='only';document.querySelectorAll('#demontCtrl .seg-btn').forEach(b=>b.classList.toggle('active',b.dataset.val==='only'));})"><div class="stat-num-val">${demont}</div><div class="stat-num-label">–î–µ–º–æ–Ω—Ç–æ–≤–∞–Ω–æ üëÜ</div></div>`;

  // –ö—Ä–∞—ó–Ω–∏ ‚Äî –∫–ª—ñ–∫ ‚Üí selectCountry
  const cC={};rawData.forEach(i=>{const c=getVal(i,'Country');if(c)cC[c]=(cC[c]||0)+1;});
  const topC=Object.entries(cC).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const maxC=topC[0][1];
  document.getElementById('statsCountries').innerHTML=topC.map(([n,c])=>
    `<div class="bar-row" onclick="applyStatFilter(()=>selectCountry('${n.replace(/'/g,"\\'")}'))" title="–§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏: ${n}">
      <div class="bar-name" title="${n}">${n}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${(c/maxC)*100}%"></div></div>
      <div class="bar-val">${c}</div>
    </div>`).join('');

  // –¢–∏–ø–∏ ‚Äî –∫–ª—ñ–∫ ‚Üí activeType
  const tC={};rawData.forEach(i=>{const t=getVal(i,'type');if(t)tC[t]=(tC[t]||0)+1;});
  document.getElementById('statsTypes').innerHTML=Object.entries(tC).sort((a,b)=>b[1]-a[1]).map(([t,c])=>{
    const conf=getTypeConf(t);
    return `<div class="legend-item" onclick="applyStatFilter(()=>{activeType='${t.replace(/'/g,"\\'")}';updateTags('type','typeTags',activeType);})" title="–§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏: ${t}">
      <div class="legend-dot" style="background:${conf.color}"></div>
      <span>${t}</span> <span style="color:#b0b8cc">${c} (${((c/total)*100).toFixed(1)}%)</span>
    </div>`;
  }).join('');

  // –î–µ—Å—è—Ç–∏–ª—ñ—Ç—Ç—è ‚Äî –∫–ª—ñ–∫ ‚Üí yearMin/yearMax
  const dC={};rawData.forEach(i=>{const y=extractYear(getVal(i,'year_start'));if(y){const d=Math.floor(y/10)*10;dC[d]=(dC[d]||0)+1;}});
  const decades=Object.keys(dC).map(Number).sort((a,b)=>a-b);
  const maxD=Math.max(...Object.values(dC));
  document.getElementById('statsDecades').innerHTML=decades.map(d=>{
    const c=dC[d];const h=Math.round((c/maxD)*70);
    return `<div class="decade-col" title="${d}‚Äì${d+9}: ${c} –æ–±'—î–∫—Ç—ñ–≤. –ö–ª—ñ–∫–Ω–∏ –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä—É"
      onclick="applyStatFilter(()=>{
        yearMin=${d};yearMax=${d+9};
        document.getElementById('yearMin').value=${d};
        document.getElementById('yearMax').value=${d+9};
        document.getElementById('yearMinLbl').textContent='${d}';
        document.getElementById('yearMaxLbl').textContent='${d+9}';
        const MIN=1860,MAX=2025;
        document.getElementById('rangeTrack').style.left=(((${d}-MIN)/(MAX-MIN))*100)+'%';
        document.getElementById('rangeTrack').style.right=((1-((${d+9}-MIN)/(MAX-MIN)))*100)+'%';
      })">
      <div class="${d>=2020?'decade-bar gold':'decade-bar'}" style="height:${h}px"></div>
      <div class="decade-lbl">${d}s</div>
    </div>`;
  }).join('');

  // –ü–æ–≤–Ω–æ—Ç–∞ ‚Äî –±–µ–∑ –∑–º—ñ–Ω
  const fields=[
    {l:'–§–æ—Ç–æ',fn:i=>!!(getVal(i,'Photo-GM')||getVal(i,'other photo link'))},
    {l:'–°–∫—É–ª—å–ø—Ç–æ—Ä',fn:i=>!!getVal(i,'sculptor')},
    {l:'–ú–∞—Ç–µ—Ä—ñ–∞–ª',fn:i=>!!getVal(i,'material')},
    {l:'–í–∏—Å–æ—Ç–∞',fn:i=>!!getVal(i,'height')},
    {l:'–í—ñ–∫—ñ–ø–µ–¥—ñ—è',fn:i=>!!getVal(i,'Wikipedia')},
    {l:'–†—ñ–∫',fn:i=>!!getVal(i,'year_start')},
    {l:'–í—É–ª–∏—Ü—è',fn:i=>!!getVal(i,'Street')}
  ];
  const cols=['#0057b7','#27a465','#c8900a','#8e44ad','#16a085','#e04040','#d35400'];
  document.getElementById('statsCompleteness').innerHTML=fields.map((f,i)=>{
    const c=rawData.filter(f.fn).length;const pct=Math.round((c/total)*100);
    return `<div class="comp-row"><div class="comp-name">${f.l}</div><div class="comp-track"><div class="comp-fill" style="width:${pct}%;background:${cols[i]}"></div></div><div class="comp-pct">${pct}%</div></div>`;
  }).join('');
}

function resetFilters(){
  document.getElementById('search').value='';
  document.getElementById('sculptorInput').value='';document.getElementById('sculptorClear').style.display='none';
  document.getElementById('toggleWiki').checked=false;
  document.getElementById('yearMin').value=1860;document.getElementById('yearMax').value=2025;
  yearMin=1860;yearMax=2025;document.getElementById('yearMinLbl').textContent='1860';document.getElementById('yearMaxLbl').textContent='2025';
  document.getElementById('rangeTrack').style.left='0%';document.getElementById('rangeTrack').style.right='0%';
  activeType='all';activeView='all';photoMode='all';demontMode='hide';
  document.querySelectorAll('#photoCtrl .seg-btn').forEach((b,i)=>b.classList.toggle('active',i===0));
  document.querySelectorAll('#demontCtrl .seg-btn').forEach((b,i)=>b.classList.toggle('active',i===0));
  activeCountry='all';activeRegion='all';
  document.querySelectorAll('#countryTags .tag-scroll-item').forEach(el=>el.classList.toggle('active',el.dataset.val==='all'));
  document.querySelectorAll('#regionTags .tag-scroll-item').forEach(el=>el.classList.toggle('active',el.dataset.val==='all'));
  document.getElementById('regionPanel').style.display='none';
  map.setView([48.5,31.2],5);
  window.history.replaceState({},'',window.location.pathname);
  renderMap();
  if(window.innerWidth<=800)toggleSidebar();
}

function geolocate(){
  const btn=document.getElementById('btnGeo');
  if(!navigator.geolocation){alert('–ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');return;}
  btn.style.background='#e8f0fb';
  navigator.geolocation.getCurrentPosition(pos=>{
    btn.style.background='white';const {latitude:lat,longitude:lng}=pos.coords;
    map.setView([lat,lng],10);
    L.circleMarker([lat,lng],{radius:11,color:'#0057b7',fillColor:'#0057b7',fillOpacity:0.35,weight:3}).addTo(map).bindPopup('üìç –í–∞—à–µ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è').openPopup();
  },()=>{btn.style.background='white';alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –ª–æ–∫–∞—Ü—ñ—é');});
}

function openRandom(){
  if(!currentFiltered.length)return;
  const currentId=new URLSearchParams(window.location.search).get('id');
  let pool=currentFiltered.filter(i=>getVal(i,'id')!==currentId);
  if(!pool.length)pool=currentFiltered;
  openPage(getVal(pool[Math.floor(Math.random()*pool.length)],'id'));
}

function switchTab(name,btn){
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');btn.classList.add('active');
}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('overlay').classList.toggle('active');}

function calcCompleteness(item){
  const fields=['Photo-GM','sculptor','material','height','Wikipedia','year_start','Street','view','type'];
  const filled=fields.filter(f=>!!getVal(item,f)).length;return{filled,total:fields.length};
}

function openPage(id){
  const item=rawData.find(i=>getVal(i,'id')===id);if(!item)return;
  // find index in currentFiltered for nav
  currentPageIndex=currentFiltered.findIndex(i=>getVal(i,'id')===id);
  const navPos=document.getElementById('navPos');
  const btnPrev=document.getElementById('btnPrev');
  const btnNext=document.getElementById('btnNext');
  if(currentPageIndex>=0&&currentFiltered.length>1){
    navPos.textContent=`${currentPageIndex+1} / ${currentFiltered.length}`;
    btnPrev.disabled=false;btnNext.disabled=false;
  } else {
    navPos.textContent='';
    btnPrev.disabled=true;btnNext.disabled=true;
  }
  window.history.pushState({},'','?id='+id);
  const lat=getVal(item,'lat').replace(',','.'),lon=getVal(item,'lon').replace(',','.');
  const city=getVal(item,'City'),type=getVal(item,'type')||"–ü–∞–º'—è—Ç–Ω–∏–∫";
  const conf=getTypeConf(type),isDem=!!getVal(item,'year_demont');
  const url=window.location.href,shareText=encodeURIComponent(city+'. '+type+'. –®–µ–≤—á–µ–Ω–∫–æ 360¬∞');
  const gml=getVal(item,'GM'),routeUrl=gml?gml:'https://www.google.com/maps/dir/?api=1&destination='+lat+','+lon;
  const cp=calcCompleteness(item);
  const segs=Array.from({length:cp.total},(_,i)=>'<div class="comp-seg '+(i<cp.filled?'filled':'empty')+'"></div>').join('');
  const extLinks=[
    {n:'Google Maps',v:gml,i:'üó∫Ô∏è'},{n:'Street View',v:getVal(item,'StreetView'),i:'üëÄ'},
    {n:'Wikimapia',v:getVal(item,'wikimapia'),i:'üåç'},{n:'Wikipedia',v:getVal(item,'Wikipedia'),i:'üìö'},
    {n:'Kobzar.ua',v:getVal(item,'kobzar.ua'),i:'üá∫üá¶'},
    {n:'OSM',v:getVal(item,'osm_id')?'https://www.openstreetmap.org/node/'+getVal(item,'osm_id'):'',i:'üß≠'},
    {n:'–ù–æ–≤–∏–Ω–∏',v:getVal(item,'news link')||getVal(item,'news links'),i:'üì∞'},
  ].filter(l=>l.v).map(l=>'<a href="'+l.v+'" target="_blank" class="ext-link-btn">'+l.i+' '+l.n+'</a>').join('');
  const img=getVal(item,'Photo-GM')||getVal(item,'other photo link');
  const demBanner=isDem?'<div class="demont-banner">‚õî –¶–µ–π –æ–±\'—î–∫—Ç –±—É–ª–æ –¥–µ–º–æ–Ω—Ç–æ–≤–∞–Ω–æ'+(getVal(item,'year_demont')?' —É '+getVal(item,'year_demont'):'')+'.</div>':'';
  const archRow=getVal(item,'arkhitector')?'<tr><td>–ê—Ä—Ö—ñ—Ç–µ–∫—Ç–æ—Ä</td><td>'+getVal(item,'arkhitector')+'</td></tr>':'';
  const heightRow=getVal(item,'height')?'<tr><td>–í–∏—Å–æ—Ç–∞</td><td>'+getVal(item,'height')+' –º</td></tr>':'';
  const safeRow=getVal(item,'safe_no')?'<tr><td>–û—Ö–æ—Ä. ‚Ññ</td><td>'+getVal(item,'safe_no')+'</td></tr>':'';
  const safeUrl=url.replace(/'/g,"\\'");
  document.getElementById('details').innerHTML=demBanner+
    '<div class="grid-main"><div><img src="'+(img||NO_PHOTO_SVG)+'" class="main-img-full" onerror="this.src=\''+NO_PHOTO_SVG+'\'"></div><div>'+
    '<div style="margin-bottom:8px"><span style="background:'+(isDem?'#888':conf.color)+';color:white;padding:4px 14px;border-radius:20px;font-size:15px;font-weight:800;text-transform:uppercase">'+type+'</span></div>'+
    '<h1 style="font-family:\'Playfair Display\',serif;font-size:36px;font-weight:900;line-height:1.15;margin-bottom:7px">'+city+'</h1>'+
    '<p style="color:var(--blue);font-weight:700;font-size:20px;margin-bottom:22px">'+getVal(item,'Country')+(getVal(item,'Region')?', '+getVal(item,'Region'):'')+' </p>'+
    '<div class="comp-label">–ü–æ–≤–Ω–æ—Ç–∞ –ø–∞—Å–ø–æ—Ä—Ç—É: '+cp.filled+'/'+cp.total+' –ø–æ–ª—ñ–≤</div>'+
    '<div class="completeness-bar">'+segs+'</div>'+
    '<table class="passport-table">'+
    '<tr><td>–ê–¥—Ä–µ—Å–∞</td><td>'+(getVal(item,'Street')||'')+' '+(getVal(item,'adr')||'‚Äî')+'</td></tr>'+
    '<tr><td>–í–∏–≥–ª—è–¥</td><td>'+(getVal(item,'view')||'‚Äî')+'</td></tr>'+
    '<tr><td>–°–∫—É–ª—å–ø—Ç–æ—Ä</td><td>'+(getVal(item,'sculptor')||'‚Äî')+'</td></tr>'+
    archRow+'<tr><td>–†—ñ–∫</td><td>'+(getVal(item,'year_start')||'‚Äî')+(isDem?' ‚Üí –∑–Ω–µ—Å–µ–Ω–æ '+getVal(item,'year_demont'):'')+' </td></tr>'+
    '<tr><td>–ú–∞—Ç–µ—Ä—ñ–∞–ª</td><td>'+(getVal(item,'material')||'‚Äî')+'</td></tr>'+heightRow+safeRow+'</table>'+
    '<div class="section-title">–û–ø–∏—Å –æ–±\'—î–∫—Ç–∞</div>'+
    '<p style="line-height:1.7;color:#444;font-size:20px;margin-bottom:24px">'+(getVal(item,'short description')||'–û–ø–∏—Å –≤—ñ–¥—Å—É—Ç–Ω—ñ–π.')+'</p>'+
    '<div class="section-title">–ö–∞—Ä—Ç–∏ —Ç–∞ –∫–∞—Ç–∞–ª–æ–≥–∏</div>'+
    '<div class="links-grid" style="margin-bottom:12px">'+(extLinks||'<span style="color:#b0b8cc;font-size:15px">–ü–æ—Å–∏–ª–∞–Ω–Ω—è –≤—ñ–¥—Å—É—Ç–Ω—ñ</span>')+'</div>'+
    '<a href="'+routeUrl+'" target="_blank" class="route-btn">üöó –ü–û–ë–£–î–£–í–ê–¢–ò –ú–ê–†–®–†–£–¢</a>'+
    '<div class="share-row">'+
    '<a href="https://t.me/share/url?url='+encodeURIComponent(url)+'&text='+shareText+'" target="_blank" class="social-btn" style="background:#229ED9">Telegram</a>'+
    '<a href="https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(url)+'" target="_blank" class="social-btn" style="background:#1877f2">Facebook</a>'+
    '<button onclick="navigator.clipboard.writeText(\''+safeUrl+'\');this.textContent=\'‚úì –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!\';setTimeout(()=>this.textContent=\'üîó –ö–æ–ø—ñ—é–≤–∞—Ç–∏\',2000)" class="social-btn" style="background:#444">üîó –ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>'+
    '</div></div></div>';
  document.getElementById('object-page').style.display='block';
  document.getElementById('object-page').scrollTop=0;
}

function closePage(){window.history.pushState({},'',window.location.pathname);document.getElementById('object-page').style.display='none';}
window.addEventListener('popstate',()=>{const id=new URLSearchParams(window.location.search).get('id');if(id)openPage(id);else document.getElementById('object-page').style.display='none';});

// ===== PREV/NEXT NAVIGATION =====
let currentPageIndex = -1;
function navObject(dir) {
  if(!currentFiltered.length) return;
  let idx = currentPageIndex + dir;
  if(idx < 0) idx = currentFiltered.length - 1;
  if(idx >= currentFiltered.length) idx = 0;
  openPage(getVal(currentFiltered[idx],'id'));
}

// ===== GAME ENGINE =====
let gameMap=null, gameGuessMarker=null, gameActualMarker=null, gameLine=null;
let gameRound=0, gameTotalScore=0, gameItems=[], gameGuessLatLng=null, gameRoundResults=[];
let gameMode='world', gameAnswerRevealed=false;
const GAME_ROUNDS=5;

const GAME_MODES={
  world:   {label:'üåç –í–µ—Å—å —Å–≤—ñ—Ç',  filter:i=>true},
  ukraine: {label:'üá∫üá¶ –£–∫—Ä–∞—ó–Ω–∞',   filter:i=>getVal(i,'Country').includes('–£–∫—Ä–∞—ó–Ω–∞')||getVal(i,'Country')==='Ukraine'},
  abroad:  {label:'‚úàÔ∏è –ó–∞–∫–æ—Ä–¥–æ–Ω–Ω—è', filter:i=>!getVal(i,'Country').includes('–£–∫—Ä–∞—ó–Ω–∞')&&getVal(i,'Country')!=='Ukraine'},
  ternopil:{label:'üåª –¢–µ—Ä–Ω–æ–ø—ñ–ª–ª—è', filter:i=>getVal(i,'Region').includes('–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞')},
};

const MAP_START={
  world:   {lat:20,lon:10,zoom:2},
  ukraine: {lat:48.5,lon:31.2,zoom:5},
  abroad:  {lat:30,lon:20,zoom:2},
  ternopil:{lat:49.5,lon:25.5,zoom:8},
};

function getStars(pts){
  if(pts>=4500)return'‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê';
  if(pts>=3500)return'‚≠ê‚≠ê‚≠ê‚≠ê';
  if(pts>=2500)return'‚≠ê‚≠ê‚≠ê';
  if(pts>=1500)return'‚≠ê‚≠ê';
  return'‚≠ê';
}
function getRank(total){
  const p=total/25000;
  if(p>=0.95)return'üèÜ –ê–±—Å–æ–ª—é—Ç–Ω–∏–π –∑–Ω–∞–≤–µ—Ü—å –®–µ–≤—á–µ–Ω–∫—ñ–∞–Ω–∏!';
  if(p>=0.80)return'ü•á –í—ñ–¥–º—ñ–Ω–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! –°–ø—Ä–∞–≤–∂–Ω—ñ–π –∑–Ω–∞–≤–µ—Ü—å!';
  if(p>=0.60)return'ü•à –î–æ–±—Ä–µ! –ù–µ–ø–æ–≥–∞–Ω–∏–π –≥–µ–æ–≥—Ä–∞—Ñ.';
  if(p>=0.40)return'ü•â –Ñ –∫—É–¥–∏ —Ä–æ—Å—Ç–∏ ‚Äî –ø—Ä–æ–¥–æ–≤–∂—É–π –≥—Ä–∞—Ç–∏!';
  return'üìç –¢—ñ–ª—å–∫–∏ –ø–æ—á–∏–Ω–∞—î—à –∑–Ω–∞–π–æ–º–∏—Ç–∏—Å—å —ñ–∑ –∫–∞—Ä—Ç–æ—é.';
}
function distKm(lat1,lon1,lat2,lon2){
  const R=6371,dLat=(lat2-lat1)*Math.PI/180,dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function calcPts(km,mode){
  // tighter scoring for small regions
  const scale=mode==='ternopil'?0.05:mode==='ukraine'?0.3:1;
  const skm=km/scale;
  if(skm<1)return 5000;
  if(skm<5)return Math.round(5000-skm*100);
  if(skm<100)return Math.round(4500-skm*20);
  if(skm<1000)return Math.max(0,Math.round(2500-skm*2));
  return Math.max(0,Math.round(500-(skm-1000)*0.25));
}

function updateGameModeCounts(){
  Object.keys(GAME_MODES).forEach(mode=>{
    const pool=rawData.filter(i=>(getVal(i,'Photo-GM')||getVal(i,'other photo link'))&&getVal(i,'lat')&&getVal(i,'lon')&&GAME_MODES[mode].filter(i));
    const el=document.getElementById('gmCount-'+mode);
    if(!el) return;
    const ok=pool.length>=5;
    el.textContent=ok?`${pool.length} –æ–±\u2019—î–∫—Ç—ñ–≤ –∑ —Ñ–æ—Ç–æ`:`‚ö†\uFE0F –õ–∏—à–µ ${pool.length} –∑ —Ñ–æ—Ç–æ`;
    const card=el.closest('.gm-card');
    if(card){card.style.opacity=ok?'1':'0.4';card.style.pointerEvents=ok?'auto':'none';}
  });
}

function showGameModes(){
  document.getElementById('gameFinal').classList.remove('active');
  document.getElementById('game-overlay').classList.remove('active');
  document.getElementById('game-mode-screen').classList.add('active');
}

function startGameMode(mode){
  gameMode=mode;
  const modeCfg=GAME_MODES[mode];
  const pool=rawData.filter(i=>(getVal(i,'Photo-GM')||getVal(i,'other photo link'))&&getVal(i,'lat')&&getVal(i,'lon')&&modeCfg.filter(i));
  if(pool.length<5){alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –æ–±\'—î–∫—Ç—ñ–≤ –∑ —Ñ–æ—Ç–æ –¥–ª—è —Ü—å–æ–≥–æ —Ä–µ–∂–∏–º—É');return;}
  gameItems=[];const used=new Set();
  while(gameItems.length<GAME_ROUNDS){
    const r=pool[Math.floor(Math.random()*pool.length)];
    const id=getVal(r,'id');
    if(!used.has(id)){used.add(id);gameItems.push(r);}
  }
  gameRound=0;gameTotalScore=0;gameRoundResults=[];
  document.getElementById('game-mode-screen').classList.remove('active');
  document.getElementById('game-overlay').classList.add('active');
  document.getElementById('gameModeBadge').textContent=modeCfg.label;

  const ms=MAP_START[mode];
  if(!gameMap){
    gameMap=L.map('game-map',{zoomControl:false}).setView([ms.lat,ms.lon],ms.zoom);
    L.control.zoom({position:'bottomright'}).addTo(gameMap);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{attribution:'¬© CARTO'}).addTo(gameMap);
    gameMap.on('click',onGameMapClick);
    gameMap.on('click',()=>document.getElementById('gameSearchResults').classList.remove('open'));
  } else {
    gameMap.setView([ms.lat,ms.lon],ms.zoom);
  }
  setTimeout(()=>gameMap.invalidateSize(),100);
  loadGameRound();
}

function buildProgressDots(){
  const el=document.getElementById('gameDots');
  el.innerHTML=Array.from({length:GAME_ROUNDS},(_,i)=>`<div class="prog-dot ${i<gameRound?'done':i===gameRound?'current':''}"></div>`).join('');
}

function loadGameRound(){
  gameGuessLatLng=null; gameAnswerRevealed=false;
  // —Å–∫–∏–Ω—É—Ç–∏ –ø–æ—à—É–∫
  const si=document.getElementById('gameSearchInput');
  if(si){si.value='';document.getElementById('gameSearchResults').classList.remove('open');}
  if(gameGuessMarker){gameMap.removeLayer(gameGuessMarker);gameGuessMarker=null;}
  if(gameActualMarker){gameMap.removeLayer(gameActualMarker);gameActualMarker=null;}
  if(gameLine){gameMap.removeLayer(gameLine);gameLine=null;}

  // Reset left panel
  document.getElementById('gameRevealPanel').classList.remove('active');
  document.getElementById('gamePhoto').style.opacity='1';
  document.getElementById('game-hint-box-wrap')&&(document.getElementById('game-hint-box-wrap').style.display='block');

  // Reset action bar
  document.getElementById('btnConfirm').disabled=true;
  document.getElementById('btnConfirm').style.display='';
  document.getElementById('btnReveal').disabled=true;
  document.getElementById('btnReveal').style.display='';
  document.getElementById('btnReveal').className='btn-reveal';
  document.getElementById('gameNextBtn').style.display='none';
  document.getElementById('gameMapPrompt').style.display='block';

  document.getElementById('gameRoundLbl').textContent=`–†–∞—É–Ω–¥ ${gameRound+1} / ${GAME_ROUNDS}`;
  document.getElementById('gameTotalPts').textContent=`${gameTotalScore} –±–∞–ª—ñ–≤`;
  buildProgressDots();

  const item=gameItems[gameRound];
  const img=getVal(item,'Photo-GM')||getVal(item,'other photo link');
  document.getElementById('gamePhoto').src=img||NO_PHOTO_SVG;

  const yr=extractYear(getVal(item,'year_start'));
  const decade=yr?`${Math.floor(yr/10)*10}-—Ç—ñ —Ä—Ä.`:'';
  const clues=[getVal(item,'type'),decade,getVal(item,'view').split(',')[0].trim()].filter(Boolean);
  document.getElementById('gameClues').innerHTML=clues.map(c=>`<div class="game-clue">${c}</div>`).join('');

  const ms=MAP_START[gameMode];
  gameMap.setView([ms.lat,ms.lon],ms.zoom);
}

function onGameMapClick(e){
  if(gameAnswerRevealed) return;
  gameGuessLatLng=e.latlng;
  if(gameGuessMarker) gameMap.removeLayer(gameGuessMarker);
  gameGuessMarker=L.marker(e.latlng,{icon:L.divIcon({
    html:'<div style="width:22px;height:22px;background:#ffd700;border-radius:50%;border:3px solid #c8900a;box-shadow:0 3px 10px rgba(0,0,0,0.5)"></div>',
    className:'',iconSize:[22,22],iconAnchor:[11,11]
  })}).addTo(gameMap);
  document.getElementById('btnConfirm').disabled=false;
  document.getElementById('btnReveal').disabled=false;
  document.getElementById('btnReveal').className='btn-reveal enabled';
  document.getElementById('gameMapPrompt').style.display='none';
}

function confirmGuess(){
  if(!gameGuessLatLng||gameAnswerRevealed) return;
  const item=gameItems[gameRound];
  const aLat=parseFloat(getVal(item,'lat').replace(',','.'));
  const aLon=parseFloat(getVal(item,'lon').replace(',','.'));
  const km=distKm(gameGuessLatLng.lat,gameGuessLatLng.lng,aLat,aLon);
  const pts=calcPts(km,gameMode);
  gameTotalScore+=pts;
  gameRoundResults.push({id:getVal(item,'id'),city:getVal(item,'City'),country:getVal(item,'Country'),km:Math.round(km),pts});
  document.getElementById('gameTotalPts').textContent=`${gameTotalScore} –±–∞–ª—ñ–≤`;
  buildProgressDots();
  revealAnswer(item,km,pts,aLat,aLon);
}

function showAnswer(){
  // reveal without scoring ‚Äî give 0 pts
  if(gameAnswerRevealed) return;
  const item=gameItems[gameRound];
  const aLat=parseFloat(getVal(item,'lat').replace(',','.'));
  const aLon=parseFloat(getVal(item,'lon').replace(',','.'));
  let km=0, pts=0;
  if(gameGuessLatLng){
    km=distKm(gameGuessLatLng.lat,gameGuessLatLng.lng,aLat,aLon);
    pts=calcPts(km,gameMode);
    gameTotalScore+=pts;
    gameRoundResults.push({id:getVal(item,'id'),city:getVal(item,'City'),country:getVal(item,'Country'),km:Math.round(km),pts});
  } else {
    // no guess was placed ‚Äî 0 pts
    gameRoundResults.push({id:getVal(item,'id'),city:getVal(item,'City'),country:getVal(item,'Country'),km:'?',pts:0});
  }
  document.getElementById('gameTotalPts').textContent=`${gameTotalScore} –±–∞–ª—ñ–≤`;
  buildProgressDots();
  revealAnswer(item,km,pts,aLat,aLon);
}

function revealAnswer(item,km,pts,aLat,aLon){
  gameAnswerRevealed=true;

  // Draw on map
  gameActualMarker=L.marker([aLat,aLon],{icon:L.divIcon({
    html:'<div style="width:24px;height:24px;background:#0057b7;border-radius:50%;border:3px solid white;box-shadow:0 3px 12px rgba(0,0,0,0.5)"></div>',
    className:'',iconSize:[24,24],iconAnchor:[12,12]
  })}).addTo(gameMap).bindPopup(`üìç ${getVal(item,'City')}, ${getVal(item,'Country')}`).openPopup();

  if(gameGuessLatLng){
    gameLine=L.polyline([[gameGuessLatLng.lat,gameGuessLatLng.lng],[aLat,aLon]],{color:'#ffd700',weight:2.5,dashArray:'7,5',opacity:0.9}).addTo(gameMap);
    gameMap.fitBounds([[gameGuessLatLng.lat,gameGuessLatLng.lng],[aLat,aLon]],{padding:[50,60],maxZoom:12});
  } else {
    gameMap.setView([aLat,aLon],10);
  }

  // Fill reveal panel (left side)
  const img=getVal(item,'Photo-GM')||getVal(item,'other photo link');
  const type=getVal(item,'type');
  const conf=getTypeConf(type);
  document.getElementById('revealImg').src=img||NO_PHOTO_SVG;
  document.getElementById('revealTypeBadge').textContent=type||"–û–±'—î–∫—Ç";
  document.getElementById('revealTypeBadge').style.background=conf.color;
  document.getElementById('revealCity').textContent=getVal(item,'City')||'‚Äî';
  document.getElementById('revealCountry').textContent=getVal(item,'Country')+(getVal(item,'Region')?', '+getVal(item,'Region'):'');
  document.getElementById('revealKm').textContent=km<1?'< 1':Math.round(km);
  document.getElementById('revealPts').textContent=`+${pts}`;
  document.getElementById('revealStars').textContent=getStars(pts);
  document.getElementById('revealYear').innerHTML=getVal(item,'year_start')?`<b>–†—ñ–∫:</b> ${getVal(item,'year_start')}`:'';
  document.getElementById('revealSculptor').innerHTML=getVal(item,'sculptor')?`<b>–°–∫—É–ª—å–ø—Ç–æ—Ä:</b> ${getVal(item,'sculptor')}`:'';
  document.getElementById('revealMaterial').innerHTML=getVal(item,'material')?`<b>–ú–∞—Ç–µ—Ä—ñ–∞–ª:</b> ${getVal(item,'material')}`:'';
  document.getElementById('revealDesc').textContent=getVal(item,'short description')||'';
  document.getElementById('gameRevealPanel').classList.add('active');

  // Update action bar ‚Äî hide guess buttons, show Next
  document.getElementById('btnConfirm').style.display='none';
  document.getElementById('btnReveal').style.display='none';
  document.getElementById('gameNextBtn').style.display='';
  document.getElementById('gameNextBtn').textContent=gameRound+1>=GAME_ROUNDS?'–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ ‚Ä∫':'–î–∞–ª—ñ ‚Ä∫';
  document.getElementById('gameMapPrompt').style.display='none';
}

function nextRound(){
  gameRound++;
  if(gameRound>=GAME_ROUNDS) showFinal();
  else loadGameRound();
}

function showFinal(){
  document.getElementById('game-overlay').classList.remove('active');
  const fin=document.getElementById('gameFinal');
  fin.classList.add('active');
  document.getElementById('finalTotal').textContent=gameTotalScore;
  document.getElementById('finalSubtitle').textContent=getRank(gameTotalScore);
  document.getElementById('finalRounds').innerHTML=gameRoundResults.map((r,i)=>
    `<div class="final-round-row">
      <span>–†–∞—É–Ω–¥ ${i+1}</span>
      <span class="rcity">${r.city}</span>
      <span class="rdist">${typeof r.km==='number'?r.km+' –∫–º':'‚Äî'}</span>
      <span class="rpts">+${r.pts}</span>
    </div>`).join('');
}

function openCurrentOnMap(){
  const item=gameItems[gameRound];
  closeGame();
  openPage(getVal(item,'id'));
}

// ===== GAME MAP SEARCH =====
// –°—Ç–∞—Ç–∏—á–Ω–∏–π —Å–ø–∏—Å–æ–∫ –∫—Ä–∞—ó–Ω + –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –¥–ª—è –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó
const GEO_PLACES=[
  {n:'–ê–≤—Å—Ç—Ä–∞–ª—ñ—è',lat:-25,lon:134,z:4},{n:'–ê–≤—Å—Ç—Ä—ñ—è',lat:47.5,lon:14,z:6},
  {n:'–ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω',lat:40.4,lon:47.6,z:6},{n:'–ê—Ä–≥–µ–Ω—Ç–∏–Ω–∞',lat:-34,lon:-64,z:4},
  {n:'–ë–µ–ª—å–≥—ñ—è',lat:50.5,lon:4.5,z:7},{n:'–ë—ñ–ª–æ—Ä—É—Å—å',lat:53.5,lon:28,z:6},
  {n:'–ë–æ–ª–≥–∞—Ä—ñ—è',lat:42.7,lon:25.5,z:6},{n:'–ë—Ä–∞–∑–∏–ª—ñ—è',lat:-10,lon:-55,z:4},
  {n:'–í–µ–ª–∏–∫–∞ –ë—Ä–∏—Ç–∞–Ω—ñ—è',lat:54,lon:-2,z:5},{n:'–í—ñ—Ä–º–µ–Ω—ñ—è',lat:40.1,lon:45,z:7},
  {n:'–ì—Ä—É–∑—ñ—è',lat:42,lon:43.5,z:6},{n:'–ì—Ä–µ—Ü—ñ—è',lat:39,lon:22,z:6},
  {n:'–ï—Å—Ç–æ–Ω—ñ—è',lat:58.5,lon:25,z:7},{n:'–Ñ–≥–∏–ø–µ—Ç',lat:26,lon:30,z:5},
  {n:'–Ü–∑—Ä–∞—ó–ª—å',lat:31.5,lon:35,z:7},{n:'–Ü—Å–ø–∞–Ω—ñ—è',lat:40,lon:-4,z:5},
  {n:'–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω',lat:48,lon:68,z:4},{n:'–ö–∞–Ω–∞–¥–∞',lat:56,lon:-96,z:4},
  {n:'–ö–∏—Ä–≥–∏–∑—Å—Ç–∞–Ω',lat:41.2,lon:74.5,z:6},{n:'–ö–∏—Ç–∞–π',lat:35,lon:105,z:4},
  {n:'–õ–∞—Ç–≤—ñ—è',lat:56.8,lon:24.6,z:7},{n:'–õ–∏—Ç–≤–∞',lat:55.8,lon:24,z:7},
  {n:'–ú–æ–ª–¥–æ–≤–∞',lat:47,lon:29,z:7},{n:'–ú–æ–Ω–≥–æ–ª—ñ—è',lat:46,lon:105,z:4},
  {n:'–ù—ñ–¥–µ—Ä–ª–∞–Ω–¥–∏',lat:52.3,lon:5.3,z:7},{n:'–ù—ñ–º–µ—á—á–∏–Ω–∞',lat:51,lon:10,z:5},
  {n:'–ù–æ—Ä–≤–µ–≥—ñ—è',lat:64,lon:14,z:5},{n:'–ü–æ–ª—å—â–∞',lat:52,lon:19,z:6},
  {n:'–ü–æ—Ä—Ç—É–≥–∞–ª—ñ—è',lat:39.5,lon:-8,z:6},{n:'—Ä–æ—Å—ñ—è',lat:60,lon:90,z:3},
  {n:'–†—É–º—É–Ω—ñ—è',lat:45.8,lon:24.9,z:6},{n:'–°–µ—Ä–±—ñ—è',lat:44,lon:21,z:6},
  {n:'–°–ª–æ–≤–∞—á—á–∏–Ω–∞',lat:48.7,lon:19.7,z:7},{n:'–°–®–ê',lat:38,lon:-97,z:4},
  {n:'–¢—É—Ä–µ—á—á–∏–Ω–∞',lat:39,lon:35,z:5},{n:'–£–≥–æ—Ä—â–∏–Ω–∞',lat:47,lon:19,z:7},
  {n:'–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω',lat:41,lon:64,z:5},{n:'–£–∫—Ä–∞—ó–Ω–∞',lat:49,lon:31,z:5},
  {n:'–§—ñ–Ω–ª—è–Ω–¥—ñ—è',lat:64,lon:26,z:5},{n:'–§—Ä–∞–Ω—Ü—ñ—è',lat:46,lon:2,z:5},
  {n:'–•–æ—Ä–≤–∞—Ç—ñ—è',lat:45.1,lon:15.5,z:7},{n:'–ß–µ—Ö—ñ—è',lat:49.8,lon:15.5,z:6},
  {n:'–®–≤–µ–π—Ü–∞—Ä—ñ—è',lat:46.8,lon:8.2,z:7},{n:'–®–≤–µ—Ü—ñ—è',lat:62,lon:15,z:5},
  // –í–µ–ª–∏–∫—ñ –º—ñ—Å—Ç–∞
  {n:'–ö–∏—ó–≤',sub:'–£–∫—Ä–∞—ó–Ω–∞',lat:50.45,lon:30.52,z:11},
  {n:'–•–∞—Ä–∫—ñ–≤',sub:'–£–∫—Ä–∞—ó–Ω–∞',lat:49.99,lon:36.23,z:11},
  {n:'–õ—å–≤—ñ–≤',sub:'–£–∫—Ä–∞—ó–Ω–∞',lat:49.84,lon:24.03,z:12},
  {n:'–û–¥–µ—Å–∞',sub:'–£–∫—Ä–∞—ó–Ω–∞',lat:46.48,lon:30.73,z:12},
  {n:'–¢–µ—Ä–Ω–æ–ø—ñ–ª—å',sub:'–£–∫—Ä–∞—ó–Ω–∞',lat:49.55,lon:25.6,z:12},
  {n:'–ù—å—é-–ô–æ—Ä–∫',sub:'–°–®–ê',lat:40.71,lon:-74.01,z:11},
  {n:'–í–∞—à–∏–Ω–≥—Ç–æ–Ω',sub:'–°–®–ê',lat:38.9,lon:-77.04,z:11},
  {n:'–¢–æ—Ä–æ–Ω—Ç–æ',sub:'–ö–∞–Ω–∞–¥–∞',lat:43.65,lon:-79.38,z:11},
  {n:'–ë—É–µ–Ω–æ—Å-–ê–π—Ä–µ—Å',sub:'–ê—Ä–≥–µ–Ω—Ç–∏–Ω–∞',lat:-34.6,lon:-58.4,z:11},
  {n:'–õ–æ–Ω–¥–æ–Ω',sub:'–í–µ–ª–∏–∫–∞ –ë—Ä–∏—Ç–∞–Ω—ñ—è',lat:51.51,lon:-0.13,z:11},
  {n:'–ë–µ—Ä–ª—ñ–Ω',sub:'–ù—ñ–º–µ—á—á–∏–Ω–∞',lat:52.52,lon:13.4,z:11},
  {n:'–í–∞—Ä—à–∞–≤–∞',sub:'–ü–æ–ª—å—â–∞',lat:52.23,lon:21.01,z:11},
  {n:'–ü—Ä–∞–≥–∞',sub:'–ß–µ—Ö—ñ—è',lat:50.08,lon:14.44,z:12},
  {n:'–Ñ—Ä–µ–≤–∞–Ω',sub:'–í—ñ—Ä–º–µ–Ω—ñ—è',lat:40.18,lon:44.51,z:12},
  {n:'–¢–±—ñ–ª—ñ—Å—ñ',sub:'–ì—Ä—É–∑—ñ—è',lat:41.69,lon:44.83,z:12},
  {n:'–ê–ª–º–∞—Ç–∏',sub:'–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω',lat:43.25,lon:76.95,z:11},
  {n:'–°—Ç–∞–º–±—É–ª',sub:'–¢—É—Ä–µ—á—á–∏–Ω–∞',lat:41.01,lon:28.98,z:11},
  {n:'–ê–Ω—Ç–∞–ª—ñ—è',sub:'–¢—É—Ä–µ—á—á–∏–Ω–∞',lat:36.9,lon:30.7,z:12},
  {n:'–ü–µ–∫—ñ–Ω',sub:'–ö–∏—Ç–∞–π',lat:39.9,lon:116.4,z:11},
  {n:'–¢–µ–ª—å-–ê–≤—ñ–≤',sub:'–Ü–∑—Ä–∞—ó–ª—å',lat:32.08,lon:34.78,z:12},
];

let gameSearchHighlight=-1;

function onGameSearch(val){
  const res=document.getElementById('gameSearchResults');
  const q=val.trim().toLowerCase();
  if(!q){res.classList.remove('open');res.innerHTML='';gameSearchHighlight=-1;return;}
  const matches=GEO_PLACES.filter(p=>p.n.toLowerCase().includes(q)||(p.sub||'').toLowerCase().includes(q)).slice(0,10);
  if(!matches.length){res.innerHTML='<div class="game-search-item" style="color:#9099b0">–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>';res.classList.add('open');return;}
  res.innerHTML=matches.map((p,i)=>
    `<div class="game-search-item" data-idx="${i}" onmousedown="gameSearchGo(${i},'${p.n.replace(/'/g,"\\'")}')">
      ${p.n}${p.sub?`<span class="gsub">${p.sub}</span>`:''}
    </div>`).join('');
  res._matches=matches;
  res.classList.add('open');
  gameSearchHighlight=-1;
}

function onGameSearchKey(e){
  const res=document.getElementById('gameSearchResults');
  const items=res.querySelectorAll('.game-search-item[data-idx]');
  if(e.key==='ArrowDown'){e.preventDefault();gameSearchHighlight=Math.min(gameSearchHighlight+1,items.length-1);}
  else if(e.key==='ArrowUp'){e.preventDefault();gameSearchHighlight=Math.max(gameSearchHighlight-1,0);}
  else if(e.key==='Enter'){e.preventDefault();if(gameSearchHighlight>=0&&res._matches)gameSearchGo(gameSearchHighlight,res._matches[gameSearchHighlight].n);return;}
  else if(e.key==='Escape'){res.classList.remove('open');return;}
  items.forEach((el,i)=>el.style.background=i===gameSearchHighlight?'#f0f7ff':'');
}

function gameSearchGo(idx,name){
  const res=document.getElementById('gameSearchResults');
  const place=res._matches&&res._matches[idx];
  if(!place)return;
  gameMap.setView([place.lat,place.lon],place.z||6,{animate:true,duration:0.8});
  document.getElementById('gameSearchInput').value=name;
  res.classList.remove('open');
  // –°–∫–∏–Ω—É—Ç–∏ –ø–æ–ª–µ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É —â–æ–± –Ω–µ –∑–∞–≤–∞–∂–∞–ª–æ
  setTimeout(()=>{document.getElementById('gameSearchInput').value='';},1200);
}

// –ó–∞–∫—Ä–∏–≤–∞—Ç–∏ dropdown –ø—Ä–∏ –∫–ª—ñ–∫—É –Ω–∞ –∫–∞—Ä—Ç—É
function closeGameSearch(){
  document.getElementById('gameSearchResults').classList.remove('open');
  document.getElementById('gameSearchInput').value='';
}


  document.getElementById('game-overlay').classList.remove('active');
  document.getElementById('game-mode-screen').classList.remove('active');
  document.getElementById('gameFinal').classList.remove('active');
  if(gameMap) setTimeout(()=>gameMap.invalidateSize(),100);
}

</script>
</body>
</html>
